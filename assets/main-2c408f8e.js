var dt=Object.defineProperty;var ht=(e,t,o)=>t in e?dt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var P=(e,t,o)=>(ht(e,typeof t!="symbol"?t+"":t,o),o);import{c as D,e as yt,a as mt,n as wt,b as bt}from"./Checkpoints-f5beaf7d.js";class X{constructor(t){this.properties=t??[]}get(t){const o=this.properties.filter(s=>s.name===t).map(s=>s.value);if(o.length>1)throw new Error('Expected only one property to be named "'+t+'"');if(o.length!==0)return o[0]}getString(t){return this.getByType(t,"string")}getNumber(t){return this.getByType(t,"number")}getBoolean(t){return this.getByType(t,"boolean")}getByType(t,o){const s=this.get(t);if(s!==void 0){if(o!=="json"&&typeof s!==o)throw new Error('Expected property "'+t+'" to have type "'+o+'"');return s}}mustGetString(t){return this.mustGetByType(t,"string")}mustGetNumber(t){return this.mustGetByType(t,"number")}mustGetBoolean(t){return this.mustGetByType(t,"boolean")}mustGetByType(t,o){const s=this.get(t);if(s===void 0)throw new Error('Property "'+t+'" is missing');if(o!=="json"&&typeof s!==o)throw new Error('Expected property "'+t+'" to have type "'+o+'"');return s}getType(t){const o=this.properties.filter(s=>s.name===t).map(s=>s.type);if(o.length>1)throw new Error('Expected only one property to be named "'+t+'"');if(o.length!==0)return o[0]}}const Xe="https://unpkg.com/@workadventure/scripting-api-extra@1.9.1/dist";class At{constructor(t){this.name=t.name,this.x=t.x,this.y=t.y,this.properties=new X(t.properties)}get isReadable(){const t=this.properties.getString("readableBy");return t?WA.player.tags.includes(t):!0}get isWritable(){const t=this.properties.getString("writableBy");return t?WA.player.tags.includes(t):!0}}function Ee(e){const t=e?"#"+e.join():"";WA.nav.openCoWebSite(Xe+"/configuration.html"+t,!0)}async function Tt(e,t){const o=await WA.room.getTiledMap(),s=new Map;return Ke(o.layers,s,e,t),s}function Ke(e,t,o,s){for(const n of e)if(n.type==="objectgroup"){for(const r of n.objects)if(r.type==="variable"||r.class==="variable"){if(o&&n.name!==o||s&&!s.includes(r.name))continue;t.set(r.name,new At(r))}}else n.type==="group"&&Ke(n.layers,t,o,s)}let ue;async function oe(){return ue===void 0&&(ue=vt()),ue}async function vt(){return Wt(await WA.room.getTiledMap())}function Wt(e){const t=new Map;return qe(e.layers,"",t),t}function qe(e,t,o){for(const s of e)s.type==="group"?qe(s.layers,t+s.name+"/",o):(s.name=t+s.name,o.set(s.name,s))}async function ze(){const e=await oe(),t=[];for(const o of e.values())if(o.type==="objectgroup")for(const s of o.objects)(s.type==="area"||s.class==="area")&&t.push(s);return t}function St(e){let t=1/0,o=1/0,s=0,n=0;const r=e.data;if(typeof r=="string")throw new Error("Unsupported tile layer data stored as string instead of CSV");for(let a=0;a<e.height;a++)for(let i=0;i<e.width;i++)r[i+a*e.width]!==0&&(t=Math.min(t,i),n=Math.max(n,i),o=Math.min(o,a),s=Math.max(s,a));return{top:o,left:t,right:n+1,bottom:s+1}}function Ye(e){let t=1/0,o=1/0,s=0,n=0;for(const r of e){const a=St(r);a.left<t&&(t=a.left),a.top<o&&(o=a.top),a.right>n&&(n=a.right),a.bottom>s&&(s=a.bottom)}return{top:o,left:t,right:n,bottom:s}}/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */var Ct=Object.prototype.toString,q=Array.isArray||function(t){return Ct.call(t)==="[object Array]"};function We(e){return typeof e=="function"}function kt(e){return q(e)?"array":typeof e}function fe(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Be(e,t){return e!=null&&typeof e=="object"&&t in e}function xt(e,t){return e!=null&&typeof e!="object"&&e.hasOwnProperty&&e.hasOwnProperty(t)}var Pt=RegExp.prototype.test;function Et(e,t){return Pt.call(e,t)}var Bt=/\S/;function It(e){return!Et(Bt,e)}var Lt={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function Dt(e){return String(e).replace(/[&<>"'`=\/]/g,function(o){return Lt[o]})}var Mt=/\s*/,$t=/\s+/,Ie=/\s*=/,Rt=/\s*\}/,Nt=/#|\^|\/|>|\{|&|=|!/;function Ft(e,t){if(!e)return[];var o=!1,s=[],n=[],r=[],a=!1,i=!1,l="",u=0;function p(){if(a&&!i)for(;r.length;)delete n[r.pop()];else r=[];a=!1,i=!1}var y,C,ne;function Q(B){if(typeof B=="string"&&(B=B.split($t,2)),!q(B)||B.length!==2)throw new Error("Invalid tags: "+B);y=new RegExp(fe(B[0])+"\\s*"),C=new RegExp("\\s*"+fe(B[1])),ne=new RegExp("\\s*"+fe("}"+B[1]))}Q(t||T.tags);for(var g=new se(e),k,f,S,_,re,$;!g.eos();){if(k=g.pos,S=g.scanUntil(y),S)for(var ce=0,gt=S.length;ce<gt;++ce)_=S.charAt(ce),It(_)?(r.push(n.length),l+=_):(i=!0,o=!0,l+=" "),n.push(["text",_,k,k+1]),k+=1,_===`
`&&(p(),l="",u=0,o=!1);if(!g.scan(y))break;if(a=!0,f=g.scan(Nt)||"name",g.scan(Mt),f==="="?(S=g.scanUntil(Ie),g.scan(Ie),g.scanUntil(C)):f==="{"?(S=g.scanUntil(ne),g.scan(Rt),g.scanUntil(C),f="&"):S=g.scanUntil(C),!g.scan(C))throw new Error("Unclosed tag at "+g.pos);if(f==">"?re=[f,S,k,g.pos,l,u,o]:re=[f,S,k,g.pos],u++,n.push(re),f==="#"||f==="^")s.push(re);else if(f==="/"){if($=s.pop(),!$)throw new Error('Unopened section "'+S+'" at '+k);if($[1]!==S)throw new Error('Unclosed section "'+$[1]+'" at '+k)}else f==="name"||f==="{"||f==="&"?i=!0:f==="="&&Q(S)}if(p(),$=s.pop(),$)throw new Error('Unclosed section "'+$[1]+'" at '+g.pos);return Ut(Ot(n))}function Ot(e){for(var t=[],o,s,n=0,r=e.length;n<r;++n)o=e[n],o&&(o[0]==="text"&&s&&s[0]==="text"?(s[1]+=o[1],s[3]=o[3]):(t.push(o),s=o));return t}function Ut(e){for(var t=[],o=t,s=[],n,r,a=0,i=e.length;a<i;++a)switch(n=e[a],n[0]){case"#":case"^":o.push(n),s.push(n),o=n[4]=[];break;case"/":r=s.pop(),r[5]=n[2],o=s.length>0?s[s.length-1][4]:t;break;default:o.push(n)}return t}function se(e){this.string=e,this.tail=e,this.pos=0}se.prototype.eos=function(){return this.tail===""};se.prototype.scan=function(t){var o=this.tail.match(t);if(!o||o.index!==0)return"";var s=o[0];return this.tail=this.tail.substring(s.length),this.pos+=s.length,s};se.prototype.scanUntil=function(t){var o=this.tail.search(t),s;switch(o){case-1:s=this.tail,this.tail="";break;case 0:s="";break;default:s=this.tail.substring(0,o),this.tail=this.tail.substring(o)}return this.pos+=s.length,s};function K(e,t){this.view=e,this.cache={".":this.view},this.parent=t}K.prototype.push=function(t){return new K(t,this)};K.prototype.lookup=function(t){var o=this.cache,s;if(o.hasOwnProperty(t))s=o[t];else{for(var n=this,r,a,i,l=!1;n;){if(t.indexOf(".")>0)for(r=n.view,a=t.split("."),i=0;r!=null&&i<a.length;)i===a.length-1&&(l=Be(r,a[i])||xt(r,a[i])),r=r[a[i++]];else r=n.view[t],l=Be(n.view,t);if(l){s=r;break}n=n.parent}o[t]=s}return We(s)&&(s=s.call(this.view)),s};function b(){this.templateCache={_cache:{},set:function(t,o){this._cache[t]=o},get:function(t){return this._cache[t]},clear:function(){this._cache={}}}}b.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};b.prototype.parse=function(t,o){var s=this.templateCache,n=t+":"+(o||T.tags).join(":"),r=typeof s<"u",a=r?s.get(n):void 0;return a==null&&(a=Ft(t,o),r&&s.set(n,a)),a};b.prototype.render=function(t,o,s,n){var r=this.getConfigTags(n),a=this.parse(t,r),i=o instanceof K?o:new K(o,void 0);return this.renderTokens(a,i,s,t,n)};b.prototype.renderTokens=function(t,o,s,n,r){for(var a="",i,l,u,p=0,y=t.length;p<y;++p)u=void 0,i=t[p],l=i[0],l==="#"?u=this.renderSection(i,o,s,n,r):l==="^"?u=this.renderInverted(i,o,s,n,r):l===">"?u=this.renderPartial(i,o,s,r):l==="&"?u=this.unescapedValue(i,o):l==="name"?u=this.escapedValue(i,o,r):l==="text"&&(u=this.rawValue(i)),u!==void 0&&(a+=u);return a};b.prototype.renderSection=function(t,o,s,n,r){var a=this,i="",l=o.lookup(t[1]);function u(C){return a.render(C,o,s,r)}if(l){if(q(l))for(var p=0,y=l.length;p<y;++p)i+=this.renderTokens(t[4],o.push(l[p]),s,n,r);else if(typeof l=="object"||typeof l=="string"||typeof l=="number")i+=this.renderTokens(t[4],o.push(l),s,n,r);else if(We(l)){if(typeof n!="string")throw new Error("Cannot use higher-order sections without the original template");l=l.call(o.view,n.slice(t[3],t[5]),u),l!=null&&(i+=l)}else i+=this.renderTokens(t[4],o,s,n,r);return i}};b.prototype.renderInverted=function(t,o,s,n,r){var a=o.lookup(t[1]);if(!a||q(a)&&a.length===0)return this.renderTokens(t[4],o,s,n,r)};b.prototype.indentPartial=function(t,o,s){for(var n=o.replace(/[^ \t]/g,""),r=t.split(`
`),a=0;a<r.length;a++)r[a].length&&(a>0||!s)&&(r[a]=n+r[a]);return r.join(`
`)};b.prototype.renderPartial=function(t,o,s,n){if(s){var r=this.getConfigTags(n),a=We(s)?s(t[1]):s[t[1]];if(a!=null){var i=t[6],l=t[5],u=t[4],p=a;l==0&&u&&(p=this.indentPartial(a,u,i));var y=this.parse(p,r);return this.renderTokens(y,o,s,p,n)}}};b.prototype.unescapedValue=function(t,o){var s=o.lookup(t[1]);if(s!=null)return s};b.prototype.escapedValue=function(t,o,s){var n=this.getConfigEscape(s)||T.escape,r=o.lookup(t[1]);if(r!=null)return typeof r=="number"&&n===T.escape?String(r):n(r)};b.prototype.rawValue=function(t){return t[1]};b.prototype.getConfigTags=function(t){return q(t)?t:t&&typeof t=="object"?t.tags:void 0};b.prototype.getConfigEscape=function(t){if(t&&typeof t=="object"&&!q(t))return t.escape};var T={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){te.templateCache=e},get templateCache(){return te.templateCache}},te=new b;T.clearCache=function(){return te.clearCache()};T.parse=function(t,o){return te.parse(t,o)};T.render=function(t,o,s,n){if(typeof t!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+kt(t)+'" was given as the first argument for mustache#render(template, view, partials)');return te.render(t,o,s,n)};T.escape=Dt;T.Scanner=se;T.Context=K;T.Writer=b;class Qe{constructor(t,o){this.template=t,this.state=o,this.ast=T.parse(t)}getValue(){return this.value===void 0&&(this.value=T.render(this.template,this.state)),this.value}onChange(t){const o=[];for(const s of this.getUsedVariables().values())o.push(this.state.onVariableChange(s).subscribe(()=>{const n=T.render(this.template,this.state);n!==this.value&&(this.value=n,t(this.value))}));return{unsubscribe:()=>{for(const s of o)s.unsubscribe()}}}isPureString(){return this.ast.length===0||this.ast.length===1&&this.ast[0][0]==="text"}getUsedVariables(){const t=new Set;return this.recursiveGetUsedVariables(this.ast,t),t}recursiveGetUsedVariables(t,o){for(const s of t){const n=s[0],r=s[1],a=s[4];["name","&","#","^"].includes(n)&&o.add(r),a!==void 0&&typeof a!="string"&&this.recursiveGetUsedVariables(a,o)}}}async function Gt(){var e;const t=await ze();for(const o of t){const s=(e=o.properties)!==null&&e!==void 0?e:[];for(const n of s){if(n.type==="int"||n.type==="bool"||n.type==="object"||typeof n.value!="string")continue;const r=new Qe(n.value,WA.state);if(r.isPureString())continue;const a=r.getValue();await Le(o.name,n.name,a),r.onChange(async i=>{await Le(o.name,n.name,i)})}}}async function Vt(){var e;const t=await oe();for(const[o,s]of t.entries())if(s.type!=="objectgroup"){const n=(e=s.properties)!==null&&e!==void 0?e:[];for(const r of n){if(r.type==="int"||r.type==="bool"||r.type==="object"||typeof r.value!="string")continue;const a=new Qe(r.value,WA.state);if(a.isPureString())continue;const i=a.getValue();De(o,r.name,i),a.onChange(l=>{De(o,r.name,l)})}}}async function Le(e,t,o){console.log(e),(await WA.room.area.get(e)).setProperty(t,o)}function De(e,t,o){WA.room.setProperty(e,t,o),t==="visible"&&(o?WA.room.showLayer(e):WA.room.hideLayer(e))}const Jt="https://admin.workadventu.re/html";let pe,Se=0,Ce=0;function Me(e){if(WA.state[e.name]){let t=e.properties.mustGetString("openLayer");for(const o of t.split(`
`))WA.room.showLayer(o);t=e.properties.mustGetString("closeLayer");for(const o of t.split(`
`))WA.room.hideLayer(o)}else{let t=e.properties.mustGetString("openLayer");for(const o of t.split(`
`))WA.room.hideLayer(o);t=e.properties.mustGetString("closeLayer");for(const o of t.split(`
`))WA.room.showLayer(o)}}function jt(e){const t=e.properties.getString("openSound"),o=e.properties.getNumber("soundRadius");let s=1;if(o){const n=Ze(e.properties.mustGetString("openLayer").split(`
`));if(n>o)return;s=1-n/o}t&&WA.sound.loadSound(t).play({volume:s})}function Ht(e){const t=e.properties.getString("closeSound"),o=e.properties.getNumber("soundRadius");let s=1;if(o){const n=Ze(e.properties.mustGetString("closeLayer").split(`
`));if(n>o)return;s=1-n/o}t&&WA.sound.loadSound(t).play({volume:s})}function _e(e){return e.map(t=>pe.get(t)).filter(t=>(t==null?void 0:t.type)==="tilelayer")}function Ze(e){const t=_e(e),o=Ye(t),s=((o.right-o.left)/2+o.left)*32,n=((o.bottom-o.top)/2+o.top)*32;return Math.sqrt(Math.pow(Se-s,2)+Math.pow(Ce-n,2))}function Xt(e){WA.state.onVariableChange(e.name).subscribe(()=>{WA.state[e.name]?jt(e):Ht(e),Me(e)}),Me(e)}function $e(e,t,o,s){const n=e.name;let r,a,i=!1;const l=o.getString("tag");let u=!0;l&&!WA.player.tags.includes(l)&&(u=!1);const p=!!l;function y(){var f;r&&r.remove(),r=WA.ui.displayActionMessage({message:(f=o.getString("closeTriggerMessage"))!==null&&f!==void 0?f:"Press SPACE to close the door",callback:()=>{WA.state[t.name]=!1,C()}})}function C(){var f;r&&r.remove(),r=WA.ui.displayActionMessage({message:(f=o.getString("openTriggerMessage"))!==null&&f!==void 0?f:"Press SPACE to open the door",callback:()=>{WA.state[t.name]=!0,y()}})}function ne(){let f;if(e.type==="tilelayer")f=Ye(_e(t.properties.mustGetString("closeLayer").split(`
`)));else{if(e.x===void 0||e.y===void 0||e.width===void 0||e.height===void 0)throw new Error(`Doorstep zone "${e.name}" is missing x, y, width or height`);f={top:e.y,left:e.x,right:e.x+e.width,bottom:e.y+e.height}}a=WA.room.website.create({name:"doorKeypad"+n,url:s+"/keypad.html#"+encodeURIComponent(n),position:{x:f.right*32,y:f.top*32,width:32*3,height:32*4},allowApi:!0})}function Q(){a&&(WA.room.website.delete(a.name),a=void 0)}function g(){if(i=!0,o.getBoolean("autoOpen")&&u){WA.state[t.name]=!0;return}if(!WA.state[t.name]&&(p&&!u||!p)&&(o.getString("code")||o.getString("codeVariable"))){ne();return}u&&(WA.state[t.name]?y():C())}function k(){i=!1,o.getBoolean("autoClose")&&(WA.state[t.name]=!1),r&&r.remove(),Q()}e.type==="tilelayer"?(WA.room.onEnterLayer(n).subscribe(g),WA.room.onLeaveLayer(n).subscribe(k)):(WA.room.area.onEnter(n).subscribe(g),WA.room.area.onLeave(n).subscribe(k)),WA.state.onVariableChange(t.name).subscribe(()=>{i&&(!o.getBoolean("autoClose")&&WA.state[t.name]===!0&&y(),a&&WA.state[t.name]===!0&&Q(),!o.getBoolean("autoOpen")&&WA.state[t.name]===!1&&C())})}function Kt(e){const t=e.properties.mustGetString("bellSound"),o=e.properties.getNumber("soundRadius");let s=1;if(o){const n=Math.sqrt(Math.pow(e.x-Se,2)+Math.pow(e.y-Ce,2));if(n>o)return;s=1-n/o}WA.sound.loadSound(t).play({volume:s})}function qt(e){WA.state[e.name]===void 0&&(WA.state[e.name]=0),WA.state.onVariableChange(e.name).subscribe(()=>{WA.state[e.name]&&Kt(e)})}function Re(e,t,o){let s;const n=t.getString("bellPopup");if(o.type==="tilelayer"){const r=o.name;WA.room.onEnterLayer(r).subscribe(()=>{var a;n?s=WA.ui.openPopup(n,"",[{label:(a=t.getString("bellButtonText"))!==null&&a!==void 0?a:"Ring",callback:()=>{WA.state[e]=WA.state[e]+1}}]):WA.state[e]=WA.state[e]+1}),WA.room.onLeaveLayer(r).subscribe(()=>{s&&(s.close(),s=void 0)})}else{const r=o.name;WA.room.area.onEnter(r).subscribe(()=>{var a;n?s=WA.ui.openPopup(n,"",[{label:(a=t.getString("bellButtonText"))!==null&&a!==void 0?a:"Ring",callback:()=>{WA.state[e]=WA.state[e]+1}}]):WA.state[e]=WA.state[e]+1}),WA.room.area.onLeave(r).subscribe(()=>{s&&(s.close(),s=void 0)})}}async function zt(e){e=e??Jt;const t=await Tt();pe=await oe();for(const o of t.values())o.properties.get("door")&&Xt(o),o.properties.get("bell")&&qt(o);for(const o of pe.values()){const s=new X(o.properties),n=s.getString("doorVariable");if(n&&o.type==="tilelayer"){const a=t.get(n);if(a===void 0)throw new Error('Cannot find variable "'+n+'" referred in the "doorVariable" property of layer "'+o.name+'"');$e(o,a,s,e)}const r=s.getString("bellVariable");r&&o.type==="tilelayer"&&Re(r,s,o)}for(const o of await ze()){const s=new X(o.properties),n=s.getString("doorVariable");if(n){const a=t.get(n);if(a===void 0)throw new Error('Cannot find variable "'+n+'" referred in the "doorVariable" property of object "'+o.name+'"');$e(o,a,s,e)}const r=s.getString("bellVariable");r&&Re(r,s,o)}WA.player.onPlayerMove(o=>{Se=o.x,Ce=o.y})}function Yt(e,t){const o=e.getString("bindVariable");if(o){const s=e.get("enterValue"),n=e.get("leaveValue"),r=e.getString("triggerMessage"),a=e.getString("tag");Qt(o,t,s,n,r,a)}}function Qt(e,t,o,s,n,r){r&&!WA.player.tags.includes(r)||(o!==void 0&&WA.room.onEnterLayer(t).subscribe(()=>{n||(WA.state[e]=o)}),s!==void 0&&WA.room.onLeaveLayer(t).subscribe(()=>{WA.state[e]=s}))}async function _t(){const e=await oe();for(const t of e.values()){const o=new X(t.properties);Yt(o,t.name)}}let Ne;async function Zt(e){const t=await WA.room.getTiledMap();e=e??Xe,Ne=await oe();const o=t.layers.find(s=>s.name==="configuration");if(o){const n=new X(o.properties).getString("tag");(!n||WA.player.tags.includes(n))&&WA.ui.registerMenuCommand("Configure the room",()=>{WA.nav.openCoWebSite(e+"/configuration.html",!0)});for(const r of Ne.values()){const a=new X(r.properties),i=a.getString("openConfig");i&&r.type==="tilelayer"&&eo(i.split(","),r.name,a)}}}function eo(e,t,o){let s;const n=o.getString("openConfigAdminTag");let r=!0;n&&!WA.player.tags.includes(n)&&(r=!1);function a(){var l;s&&s.remove(),s=WA.ui.displayActionMessage({message:(l=o.getString("openConfigTriggerMessage"))!==null&&l!==void 0?l:"Press SPACE or touch here to configure",callback:()=>Ee(e)})}function i(){WA.nav.closeCoWebSite()}WA.room.onEnterLayer(t).subscribe(()=>{const l=o.getString("openConfigTrigger");r&&(l&&l==="onaction"?a():Ee(e))}),WA.room.onLeaveLayer(t).subscribe(()=>{s&&s.remove(),i()})}function to(){return WA.onInit().then(()=>{zt().catch(e=>console.error(e)),_t().catch(e=>console.error(e)),Zt().catch(e=>console.error(e)),Vt().catch(e=>console.error(e)),Gt().catch(e=>console.error(e))}).catch(e=>console.error(e))}let et="https://admin.workadventu.re";function tt(){const e=WA.player.userRoomToken;if(e===void 0)throw new Error("No userRoomToken found. The quests plugin can only work with WorkAdventure SAAS edition (at https://play.workadventu.re).");return e}async function oo(e,t){if(!WA.player.isLogged)throw new Error("You must be logged to gain XP.");const o=new URL(`/api/quests/${e}/level-up`,et),s=await fetch(o,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:tt()},body:JSON.stringify({xp:t})});if(!s.ok)throw new Error(`An error occurred. HTTP Code: ${s.status} ${s.statusText}.`);const n=await s.json();return n.awardedBadges.length>0&&(async()=>{for(const r of n.awardedBadges)await so(e,r)})().catch(r=>{console.error(r)}),n}async function so(e,t){const o=new URL(`/quests/${e}/badge/${t}/congratulations`,et);o.search=new URLSearchParams({token:tt()}).toString(),await WA.ui.website.open({url:o.toString(),position:{vertical:"middle",horizontal:"middle"},allowApi:!0,visible:!0,size:{width:"100%",height:"100%"}})}class no{constructor(t){P(this,"state");P(this,"observers",[]);this.state=t}getState(){return this.state}setState(t){this.state=t,this.notifyObservers()}addObserver(t){this.observers.push(t)}notifyObservers(){this.observers.forEach(t=>t(this.state))}}const N=class N{constructor(){P(this,"state");this.state=new no({currentMap:"town",playerTags:[],rootUrl:"",checkpointIds:[],checklist:[]})}static getInstance(){return N.instance||(N.instance=new N),N.instance}getState(){return this.state.getState()}setState(t){this.state.setState(t)}subscribe(t){this.state.addObserver(t)}};P(N,"instance");let ge=N;const h=ge.getInstance(),F=class F{constructor(){}static getInstance(){return F.instance||(F.instance=new F),F.instance}getState(){return h.getState().currentMap}setState(t){const s={...h.getState(),currentMap:t};h.setState(s)}subscribe(t){h.subscribe(o=>{t(o.currentMap)})}initState(){this.setState(WA.state.map)}isTown(){return this.getState()==="town"}isWorld(){return this.getState()==="world"}};P(F,"instance");let de=F;const L=de.getInstance(),O=class O{constructor(){}static getInstance(){return O.instance||(O.instance=new O),O.instance}getState(){return h.getState().checkpointIds}setState(t){const s={...h.getState(),checkpointIds:t};h.setState(s)}subscribe(t){h.subscribe(o=>{t(o.checkpointIds)})}async initAsyncState(){let t=await WA.player.state.checkpointIds;(!t||t.length<=1)&&(console.log("New player"),t=["0"]),console.log("initAsyncState checkpointIds",t),await this.setAsyncState(t)}async getAsyncState(){return this.getState()?this.getState():await WA.player.state.checkpointIds}async setAsyncState(t){this.setState(t),await WA.player.state.saveVariable("checkpointIds",t,{public:!1,persist:!0,scope:"world"})}async addCheckpointId(t){const o=this.getState();o.push(t),await this.setAsyncState(o)}getPassedCheckpointIdsOfMap(){const t=L.getState(),o=this.getState();return D.filter(s=>s.map===t&&o.includes(s.id)).map(s=>s.id)}getNextCheckpointId(t){const o=t.find(s=>!s.done);return o?o.id:"-1"}getJonasCheckpointIds(){return D.filter(t=>(t==null?void 0:t.npcName)==="Jonas").map(t=>t.id)}getCheckpointXP(t){const o=D.find(s=>s.id===t);return o?o.xp:0}getNextJonasCheckpointId(){console.log("getNextJonasCheckpointId()");const t=this.getState().map(Number);console.log("numericPlayerCheckpointIds",t);const o=this.getJonasCheckpointIds().map(Number);console.log("numericJonasCheckpoints",o);const s=Math.max(...t);console.log("maxPlayerCheckpointId",s);const n=o.find(r=>r>s);return console.log("nextJonasCheckpointId",n),console.log("return => ",n!==void 0?n.toString():"-1"),n!==void 0?n.toString():"-1"}isCheckpointPassed(t){return this.getState().includes(t)}hasPlayerMetJonas(){return this.getState().includes("2")}isCheckpointAfterFirstJonas(t){return parseInt(t,10)>2}canEnterCaveWorld(){return this.getState().includes("4")}hasPlayerTalkedWithJonasInTheCave(){return this.getState().includes("6")}isCheckpointJonasPhone(t){return t==="7"}canLeaveCaveWorld(){return this.getState().includes("7")}canAccessAchievements(){return this.getState().includes("9")}canAccessValues(){return this.getState().includes("10")}canAccessLegal(){return this.getState().includes("11")}canAccessBridge(){return this.getState().includes("12")}canAccessFrance(){return this.getState().includes("13")}canAccessHungary(){return["14","15"].every(t=>this.getState().includes(t))}canAccessBelgium(){return["16","17"].every(t=>this.getState().includes(t))}canAccessNetherlands(){return["18","19"].every(t=>this.getState().includes(t))}canEnterAirport(){return["20","21"].every(t=>this.getState().includes(t))}canEnterAirportGates(){return this.getState().includes("22")}canEnterBRTower(){return this.getState().includes("24")}isCheckpointInBrTower(t){const o=parseInt(t,10);return 25<=o&&o<=29}canEnterBRTowerFloor3(){return this.getState().includes("25")}canEnterBRTowerFloor2(){return this.getState().includes("26")}canEnterBRTowerFloor1(){return this.getState().includes("27")}canEnterBRTowerFloor0(){return this.getState().includes("28")}canLeaveBRTower(){return this.getState().includes("29")}isWorldMapDone(){return this.getState().includes("32")}isBackstageDone(){return["33","34"].every(t=>this.getState().includes(t))}isContentFRChecked(){return["39","40","41"].every(t=>this.getState().includes(t))}isContentPTChecked(){return["42","43","44"].every(t=>this.getState().includes(t))}isContentALTChecked(){return["45","46","47"].every(t=>this.getState().includes(t))}isContentEXTChecked(){return["48","49"].every(t=>this.getState().includes(t))}isLockedCheckpointAfterOnboarding(t){const o=parseInt(t,10);return 33<=o&&o<=39}};P(O,"instance");let he=O;const c=he.getInstance(),U=class U{constructor(){}static getInstance(){return U.instance||(U.instance=new U),U.instance}getState(){return h.getState().playerTags}setState(t){const s={...h.getState(),playerTags:t};h.setState(s)}subscribe(t){h.subscribe(o=>{t(o.playerTags)})}initState(){console.log("Player tags",WA.player.tags),this.setState(WA.player.tags)}hasMandatoryTags(){return this.getState().some(o=>yt.includes(o))}hasMandatoryTagsIn(t){return this.getState().some(s=>t.includes(s))}isAdmin(){return this.getState().some(o=>o==="admin")}isEmployee(){return this.getState().some(o=>mt.includes(o))}isHr(){return this.getState().some(o=>["admin","hr"].includes(o))}isNewbie(){return this.getState().some(o=>wt.includes(o))}hasFrProfile(){return this.getState().some(o=>o==="fr")}hasPtProfile(){return this.getState().some(o=>o==="pt")}hasAltProfile(){return this.getState().some(o=>o==="alt")}hasExtProfile(){return this.getState().some(o=>o==="ext")}isGuest(){return this.getState().some(o=>o==="guest")}isOtherThanGuest(){return this.getState().some(o=>bt.includes(o))}};P(U,"instance");let ye=U;const m=ye.getInstance();async function x(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}function Fe(e){return typeof e!="string"?!1:e.startsWith("http")}function ro(e){return e.includes("atlassian")}const G=class G{constructor(){}static getInstance(){return G.instance||(G.instance=new G),G.instance}getState(){return h.getState().rootUrl}setState(t){const s={...h.getState(),rootUrl:t};h.setState(s)}subscribe(t){h.subscribe(o=>{t(o.rootUrl)})}initState(){const t=WA.room.mapURL,o=t.substring(0,t.lastIndexOf("/"));this.setState(o)}};P(G,"instance");let me=G;const z=me.getInstance(),ao="The door is locked. You are not qualified to enter here.";let ie,we,Z;async function Oe(e){console.log("openDialogueBox");const t=z.getState();ie=await WA.ui.website.open({url:t+`/dialogue-box/index.html?id=${e}`,visible:!0,allowApi:!0,allowPolicy:"",position:{vertical:"bottom",horizontal:"middle"},size:{height:"120px",width:"650px"},margin:{bottom:"70px"}})}async function Ue(){const e=ie;e&&(await e.close(),ie===e&&(ie=null))}async function ot(e){const t=z.getState(),o=Fe(e)?e:`${t}/content/${e}`;Fe(e)&&ro(e)?WA.nav.openTab(o):Z=await WA.nav.openCoWebSite(o,!1,"accelerometer; autoplay; camera; encrypted-media; gyroscope; picture-in-picture",70,1,!0,!1)}async function Ge(){const e=Z;e&&(console.log("coWebsite",Z),await e.close(),Z===e&&(Z=null))}function st(e){if(console.log("Display banner of checkpoint",e),e==="-1"){WA.ui.banner.openBanner({id:"onboarding-banner",text:"CONGRATULATIONS! YOU HAVE SUCCESSFULLY VISITED ALL THE CHECKPOINTS!",bgColor:"#3402F0",textColor:"#FFFFFF",closable:!1,timeToClose:12e4});return}const t=D.find(o=>o.id===e);t&&WA.ui.banner.openBanner({id:"onboarding-banner",text:`${t.title}: ${t.description}`,bgColor:"#3402F0",textColor:"#FFFFFF",closable:!1,timeToClose:12e4})}function ke(e=ao){console.log("Open error banner with message",e),WA.ui.banner.openBanner({id:"onboarding-banner",text:e,bgColor:"#FD4D26",textColor:"#FFFFFF",closable:!1,timeToClose:3e3})}function xe(){WA.ui.banner.closeBanner()}function io(){const e=z.getState();WA.ui.actionBar.addButton({id:"checklist-btn",type:"action",imageSrc:`${e}/checklist-icon.svg`,toolTip:"Onboarding Checklist",callback:()=>{WA.ui.modal.openModal({title:"Plan",src:`${e}/checklist/index.html`,allowApi:!0,allow:"microphone; camera",position:"center"},()=>WA.ui.modal.closeModal())}})}function lo(){const e=z.getState();WA.ui.actionBar.addButton({id:"help-btn",type:"action",imageSrc:`${e}/help.svg`,toolTip:"User guide",callback:()=>{WA.ui.modal.openModal({title:"User guide",src:`${e}/User_Guide.pdf`,allowApi:!0,allow:"microphone; camera",position:"center"},()=>WA.ui.modal.closeModal())}})}function co(){WA.ui.modal.openModal({title:"Feedback",src:"https://forms.gle/MREVyCmEUf9Exfqt5",allowApi:!1,allow:"microphone; camera",position:"center"},()=>WA.ui.modal.closeModal())}async function uo(){const e=z.getState();we=await WA.ui.website.open({url:`${e}/helicopter.gif`,visible:!0,allowApi:!1,allowPolicy:"",position:{vertical:"middle",horizontal:"middle"},size:{height:"500px",width:"500px"}})}async function fo(){we&&await we.close()}const Ve="/@/bedrock-1710774685/onboardingbr",po={town:`${Ve}/town`,world:`${Ve}/e-learning`},j=["ext","0","1","2","3","4","roof"],nt={roof:null,4:{x:31,y:124},3:{x:29,y:129},2:{x:29,y:137},1:{x:17,y:143},0:{x:28,y:150},ext:null};function w(e,t){const o=[],[s,n]=e,[r,a]=t;for(let i=n;i<=a;i++)for(let l=s;l<=r;l++)o.push([l,i]);return o}const V=class V{constructor(){}static getInstance(){return V.instance||(V.instance=new V),V.instance}getState(){return h.getState().checklist}setState(t){const s={...h.getState(),checklist:t};h.setState(s)}subscribe(t){h.subscribe(o=>{t(o.checklist)})}async getAsyncState(){return this.getState()?this.getState():await WA.player.state.checklist}async setAsyncState(t){console.log("setAsyncState (checklist)",t),this.setState(t),await WA.player.state.saveVariable("checklist",t,{public:!1,persist:!0,scope:"world"})}async markCheckpointAsDone(t){const o=this.getState(),s=o.findIndex(n=>n.id===t);o[s].done=s!==-1,await this.setAsyncState(o)}};P(V,"instance");let be=V;const Ae=be.getInstance();let Je=!1;async function rt(){const e=[];console.log("Processing areas..."),D.forEach(o=>{yo(o)&&(e.push({id:o.id,title:o.title,done:c.isCheckpointPassed(o.id)}),ho(o)&&mo(o)&&wo(o)&&Pe(o))}),await Ae.setAsyncState(e);const t=c.getNextCheckpointId(e);st(t)}function go(e){console.log(`Placing checkpoint ${e.id} (area)`);const t=32,o=128,s=e.coordinates.x*t,n=e.coordinates.y*t,r=s-(o-t)/2,a=n-(o-t)/2;WA.room.area.create({name:e.id,x:r,y:a,width:o,height:o}),WA.room.area.onEnter(e.id).subscribe(async()=>{console.log("Entered checkpoint area",e.id),WA.controls.disablePlayerProximityMeeting(),console.log("disablePlayerProximityMeeting()"),e.type==="NPC"&&e.message?await Oe(e.id):e.type==="content"&&e.url?await ot(e.url):e.type==="direction"&&e.message&&await Oe(e.id)}),WA.room.area.onLeave(e.id).subscribe(async()=>{if(console.log("Leaved checkpoint area",e.id),console.log("restorePlayerProximityMeeting()"),WA.controls.restorePlayerProximityMeeting(),e.type==="NPC")await Ue(),e.url&&await Ge();else if(e.type==="content"){if(await Wo(e),await ve(e.id),c.isCheckpointJonasPhone(e.id))return;await Ge()}else e.type==="direction"&&(e.message?await Ue():(await le(e.id),at(e),await ve(e.id)))})}async function le(e){console.log(`Removing checkpoint area ${e}`),console.log("restorePlayerProximityMeeting()"),WA.controls.restorePlayerProximityMeeting(),await WA.room.area.delete(e)}function ho(e){const t=e.id;return L.getState()!==e.map?(console.log(`Ignoring checkpoint ${t} (not the right map)`),!1):!0}function yo(e){const t=e.id,o=e.tags;return console.log("Filter checkpoint: ",e.title),o&&!m.hasMandatoryTagsIn(o)?(console.log(`Ignoring checkpoint ${t} (not the right tags)`),!1):!0}function mo(e){const t=e.id;return c.isCheckpointJonasPhone(t)&&(!c.hasPlayerTalkedWithJonasInTheCave()||c.canLeaveCaveWorld())?(console.log(`Ignoring checkpoint ${t} (milestone Jonas phone)`),!1):c.isCheckpointAfterFirstJonas(t)&&!c.hasPlayerMetJonas()?(console.log(`Ignoring checkpoint ${t} (milestone meet Jonas)`),!1):c.isLockedCheckpointAfterOnboarding(t)&&!c.isWorldMapDone()?(console.log(`Ignoring checkpoint ${t} (milestone onboarding)`),!1):!0}function wo(e){const t=e.id;if(c.isCheckpointPassed(t)){if(e.type==="NPC"&&e.npcName==="Jonas")return console.log(`Ignoring checkpoint ${t} (already met this Jonas)`),!1;if(e.type==="direction")return console.log(`Ignoring checkpoint ${t} (already passed this direction)`),!1}else if(e.type==="NPC"&&e.npcName==="Jonas"){if(console.log("*****************"),console.log("Jonas checkpoint",e.id),Je)return console.log(`Ignoring checkpoint ${t} (next Jonas is already placed)`),!1;console.log("place this Jonas"),Je=!0}return!0}function bo(e){e.type==="NPC"?Ao(e):e.type==="content"?To(e):e.type==="direction"?So(e):console.error("Invalid area type while placing tile")}function Ao(e){if(console.log(`Placing checkpoint ${e.id} (NPC tile)`),e.npcName&&e.npcSprite){const t=e.npcName.toLowerCase();WA.room.setTiles([{x:e.coordinates.x,y:e.coordinates.y,tile:`npc-${t}-${e.npcSprite}`,layer:c.isCheckpointInBrTower(e.id)?"tower/content":"furniture/furniture3"}])}}function To(e){console.log(`Placing checkpoint ${e.id} (content tile)`),WA.room.setTiles([{x:e.coordinates.x,y:e.coordinates.y,tile:"content",layer:c.isCheckpointInBrTower(e.id)?"tower/content":"furniture/furniture1"}]),c.isCheckpointJonasPhone(e.id)&&WA.room.setTiles([{x:e.coordinates.x,y:e.coordinates.y,tile:"smartphone",layer:"furniture/furniture2"}])}function vo(e){WA.room.setTiles([{x:e.coordinates.x,y:e.coordinates.y,tile:null,layer:c.isCheckpointInBrTower(e.id)?"tower/content":"furniture/furniture3"}])}async function Wo(e){WA.room.setTiles([{x:e.coordinates.x,y:e.coordinates.y,tile:null,layer:c.isCheckpointInBrTower(e.id)?"tower/content":"furniture/furniture1"}]),c.isCheckpointJonasPhone(e.id)&&(await le(e.id),WA.room.setTiles([{x:e.coordinates.x,y:e.coordinates.y,tile:null,layer:"furniture/furniture2"}]))}function So(e){console.log(`Placing checkpoint ${e.id} (direction tile)`),WA.room.setTiles([{x:e.coordinates.x,y:e.coordinates.y,tile:"direction",layer:"furniture/furniture1"}])}function at(e){WA.room.setTiles([{x:e.coordinates.x,y:e.coordinates.y,tile:null,layer:"furniture/furniture1"}])}function Co(e,t){ko(e,t),xo(e,t)}function ko(e,t){WA.room.setTiles([{x:e,y:t,tile:"npc-jonas-tp",layer:"furniture/furniture3"}]),setTimeout(()=>{WA.room.setTiles([{x:e,y:t,tile:null,layer:"furniture/furniture3"}])},1e3)}function xo(e,t){const r=[{dx:-1,dy:-1,id:1},{dx:0,dy:-1,id:2},{dx:1,dy:-1,id:3},{dx:-1,dy:0,id:4},{dx:0,dy:0,id:5},{dx:1,dy:0,id:6},{dx:-1,dy:1,id:7},{dx:0,dy:1,id:8},{dx:1,dy:1,id:9}],a=r.map(({dx:i,dy:l,id:u})=>({x:e+i,y:t+l,tile:`teleport-${u}`,layer:"above/above1"}));WA.room.setTiles(a),setTimeout(()=>{const i=r.map(({dx:l,dy:u})=>({x:e+l,y:t+u,tile:null,layer:"above/above1"}));WA.room.setTiles(i)},1800)}function Po(){const e=w([34,10],[40,14]),t=e.map(([s,n])=>({x:s,y:n,tile:null,layer:"furniture/furniture1"})),o=e.map(([s,n])=>({x:s,y:n,tile:null,layer:"above/above1"}));WA.room.setTiles([...t,...o])}function Eo(){console.log("placeRooftopHelicopter()");const t=w([26,114],[32,118]).map(([o,s],n)=>({x:o,y:s,tile:`helicopter-landed-${n+1}`,layer:"above/above1"}));WA.room.setTiles(t)}function Bo(e){const t=[],o=nt[e];o!==null&&(console.log("place building tile on coordinates",o),t.push({x:o.x,y:o.y,tile:`hide-checkpoint-floor-${e}`,layer:"above/above2"})),WA.room.setTiles(t)}function Io(e){const t=[],o=nt[e];o!==null&&(console.log("remove building tile on coordinates",o),t.push({x:o.x,y:o.y,tile:null,layer:"above/above2"})),WA.room.setTiles(t)}function je(){L.isTown()?Do():L.isWorld()&&Go()}async function Y(e,t){let o=po[e];t&&(o+=`#${t}`,await it(!0)),WA.nav.goToRoom(o)}async function it(e){await WA.player.state.saveVariable("playerCameFromDoor",e,{public:!1,persist:!0,scope:"world"})}const d={hr:{access:!0,blockingTiles:[[80,74],[83,74]]},arcade:{access:!1,blockingTiles:[[16,116],[19,116]]},stadium:{access:!1,blockingTiles:[[18,77],[20,77]]},wikitech:{access:!1,blockingTiles:[[77,110],[82,110]]},streaming:{access:!1,blockingTiles:[[71,40],[75,40]]},cave:{access:!1,blockingTiles:[[49,11],[50,11]]},backstage:{access:!1,blockingTiles:[[29,50],[30,51]]},service:{access:!1,blockingTiles:[[10,39],[12,41]]}},E={alt:{access:!1,leftWall:[[41,4],[41,5]],rightWall:[[44,4],[44,5]],pillar:[[42,5],[43,6]]},fr:{access:!1,leftWall:[[45,2],[45,3]],rightWall:[[48,2],[48,3]],pillar:[[46,3],[47,4]]},ext:{access:!1,leftWall:[[50,2],[50,3]],rightWall:[[53,2],[53,3]],pillar:[[51,3],[52,4]]},pt:{access:!1,leftWall:[[54,4],[54,5]],rightWall:[[57,4],[57,5]],pillar:[[55,5],[56,6]]}},M={hrMeetingDoor1:{access:!1,tilesNamePattern:"hr-meeting-door",tilesCoordinates:[[71,62],[72,63]]},hrMeetingDoor2:{access:!1,tilesNamePattern:"hr-meeting-door",tilesCoordinates:[[76,62],[77,63]]},hrMeetingDoor3:{access:!1,tilesNamePattern:"hr-meeting-door",tilesCoordinates:[[88,62],[89,63]]},hrMeetingDoor4:{access:!1,tilesNamePattern:"hr-meeting-door",tilesCoordinates:[[93,62],[94,63]]}},Lo=["world-from-alt","world-from-ext","world-from-fr","world-from-pt"];function Do(){if(m.isGuest())Object.keys(d).forEach(e=>{d[e].access=e==="hr"||e==="arcade"});else if(m.isOtherThanGuest()){const e=c.isBackstageDone();d.stadium.access=!0,d.cave.access=!0,d.hr.access=!0,d.service.access=c.isWorldMapDone(),d.arcade.access=e,d.streaming.access=e,d.wikitech.access=e,d.backstage.access=e,c.canEnterCaveWorld()&&(E.fr.access=m.hasFrProfile(),E.pt.access=m.hasPtProfile(),E.alt.access=m.hasAltProfile(),E.ext.access=m.hasExtProfile()),m.isEmployee()&&(console.log("Open all town buildings"),Object.keys(d).forEach(t=>{d[t].access=!0}),E.fr.access=!0)}for(const e in d)$o(e);for(const e in M)Ro(e),No(e);Oo();for(const e of Lo)Mo(e);console.log("townBuildings",d),console.log("townCaveProfileDoors",E),console.log("hrMeetingDoors",M)}function Mo(e){console.log("listenTownExits()"),WA.room.area.onEnter(`to-${e}`).subscribe(async()=>{await Y("world","from-town")})}function $o(e){console.log("listenTownDoor()");let t;o("BACK"),o("BACKSTAGE"),o("AUDITORIUM"),o("FRONT");function o(r){WA.room.area.onEnter(`playerPosition_${r}`).subscribe(()=>{console.log("onEnter",`${r}`),t=r})}function s(){console.log(`toggle ${e}Door`),ee(e);const r="roofs/backstage1",a="roofs/stadium1";switch(e){case"service":t==="BACK"?(WA.room.hideLayer(r),WA.room.hideLayer(a)):t==="BACKSTAGE"&&(WA.room.showLayer(r),WA.room.showLayer(a));break;case"backstage":t==="BACKSTAGE"?WA.room.showLayer(r):t==="AUDITORIUM"&&WA.room.hideLayer(r);break;case"stadium":t==="AUDITORIUM"?WA.room.showLayer(a):t==="FRONT"&&WA.room.hideLayer(a);break;default:n===!0?(console.log("was visible before"),n=!1,console.log("hide all roofs"),WA.room.hideLayer(`roofs/${e}1`),WA.room.hideLayer(`roofs/${e}2`)):(console.log("was hidden before"),n=!0,console.log("show all roofs"),WA.room.showLayer(`roofs/${e}1`),WA.room.showLayer(`roofs/${e}2`));break}}let n=!0;WA.room.area.onEnter(`${e}Door`).subscribe(()=>{console.log("onEnter",`${e}Door`),console.log("has access",d[e].access),d[e].access?s():ke()}),WA.room.area.onLeave(`${e}Door`).subscribe(()=>{console.log("onLeave",`${e}Door`),d[e].access||(console.log("closeBanner"),xe())}),d[e].access||(console.log("lock door"),Fo(e))}function Ro(e){const t=WA.state.loadVariable(`${e}Variable`);M[e].access=t,lt(e)}function No(e){let t;m.isHr()&&(WA.room.area.onEnter(e).subscribe(()=>{t=WA.ui.displayActionMessage({message:`Press SPACE to ${M[e].access?"close":"open"} the door`,callback:async()=>{await WA.state.saveVariable(`${e}Variable`,!M[e].access)}})}),WA.room.area.onLeave(e).subscribe(async()=>{await(t==null?void 0:t.remove().then(()=>{t=null}))})),WA.state.onVariableChange(`${e}Variable`).subscribe(o=>{M[e].access=o,lt(e)})}function lt(e){const t=M[e],o=w(t.tilesCoordinates[0],t.tilesCoordinates[1]),s=`${t.tilesNamePattern}-${M[e].access?"open":"closed"}`,n=o.map(([r,a],i)=>({x:r,y:a,tile:`${s}-${i+1}`,layer:"furniture/furniture2"}));WA.room.setTiles(n)}function Fo(e){const t=d[e],s=w(t.blockingTiles[0],t.blockingTiles[1]).map(([n,r])=>({x:n,y:r,tile:"collision",layer:"collisions"}));WA.room.setTiles(s)}function ee(e){d[e].access=!0;const t=d[e],s=w(t.blockingTiles[0],t.blockingTiles[1]).map(([n,r])=>({x:n,y:r,tile:null,layer:"collisions"}));WA.room.setTiles(s)}function Oo(){Object.keys(E).forEach(e=>{E[e].access===!0&&ct(e)})}function ct(e){E[e].access=!0;const t=E[e],o=w(t.pillar[0],t.pillar[1]),s=w(t.leftWall[0],t.leftWall[1]),n=w(t.rightWall[0],t.rightWall[1]),r=o.map(([u,p],y)=>({x:u,y:p,tile:`no-pillar-${y+1}`,layer:"walls/walls1"})),a=s.map(([u,p],y)=>({x:u,y:p,tile:`cave-door-wall-open-${y+1}`,layer:"walls/walls1"})),i=n.map(([u,p],y)=>({x:u,y:p,tile:`cave-door-wall-open-${y+1}`,layer:"walls/walls1"})),l=[...r,...a,...i];WA.room.setTiles(l)}function Uo(){let e=null;return m.hasFrProfile()?e="fr":m.hasAltProfile()?e="alt":m.hasExtProfile()?e="ext":m.hasPtProfile()&&(e="pt"),e}const W={cave:{access:!1,blockingTiles:[[28,181],[29,182]]},airport:{access:!1,blockingTiles:[[51,22],[53,22]]}},A={achievements:{access:!1,blockingTiles:[[84,168],[86,168]]},values:{access:!1,blockingTiles:[[61,160],[61,162]]},legal:{access:!1,blockingTiles:[[37,109],[37,110]]},bridge:{access:!1,blockingTiles:[[18,83],[21,83]]},france:{access:!1,blockingTiles:[[19,66],[21,68]]},hungary:{access:!1,blockingTiles:[[91,59],[92,59]]},belgium:{access:!1,blockingTiles:[[104,27],[105,27]]},netherlands:{access:!1,blockingTiles:[[71,21],[74,21]]}},J={access:!1,turnstile:[[52,11],[52,12]],lightsY:[[52,6],[52,10]],lightsX:[[48,5],[52,5]]},v={floor4:{access:!1,tilesNamePattern:"rooftop-to-floor4",tilesCoordinates:[[23,117],[23,117]]},floor3:{access:!1,tilesNamePattern:"floor4-to-floor3",tilesCoordinates:[[22,126],[25,126]]},floor2:{access:!1,tilesNamePattern:"floor3-to-floor2",tilesCoordinates:[[22,133],[25,133]]},floor1:{access:!1,tilesNamePattern:"floor2-to-floor1",tilesCoordinates:[[22,140],[25,140]]},floor0:{access:!1,tilesNamePattern:"floor1-to-floor0",tilesCoordinates:[[22,147],[25,147]]},exit:{access:!1,tilesNamePattern:"floor0-to-exit",tilesCoordinates:[[22,154],[25,154]]}};function Go(){W.cave.access=c.canLeaveCaveWorld(),W.airport.access=c.canEnterAirport(),A.achievements.access=c.canAccessAchievements(),A.values.access=c.canAccessValues(),A.legal.access=c.canAccessLegal(),A.bridge.access=c.canAccessBridge(),A.france.access=c.canAccessFrance(),A.hungary.access=c.canAccessHungary(),A.belgium.access=c.canAccessBelgium(),A.netherlands.access=c.canAccessNetherlands(),J.access=c.canEnterAirportGates(),v.floor4.access=c.canEnterBRTower(),v.floor3.access=c.canEnterBRTowerFloor3(),v.floor2.access=c.canEnterBRTowerFloor2(),v.floor1.access=c.canEnterBRTowerFloor1(),v.floor0.access=c.canEnterBRTowerFloor0(),v.exit.access=c.canLeaveBRTower(),m.isEmployee()&&(console.log("Open all world buildings"),Object.keys(W).forEach(e=>{W[e].access=!0}),Object.keys(A).forEach(e=>{A[e].access=!0}),J.access=!0,Object.keys(v).forEach(e=>{v[e].access=!0}));for(const e in W)Jo(e);jo(),Xo(),J.access&&ut(),qo(),Vo("town"),console.log("worldBuildings",W),console.log("worldBarriers",A),console.log("airportGate",J),console.log("brTowerFloors",v)}function Vo(e){console.log("listenWorldExits()"),WA.room.area.onEnter(`to-${e}`).subscribe(async()=>{await Y("town","from-world")})}function Jo(e){console.log("> listenWorldDoor()");function t(){console.log(`toggle ${e}Door`),Te(e),o===!0?(console.log("was visible before"),o=!1,console.log("hide layer"),WA.room.hideLayer(`roofs/${e}1`)):(console.log("was hidden before"),o=!0,console.log("show layer"),WA.room.showLayer(`roofs/${e}1`))}let o=e!=="cave";WA.room.area.onEnter(`${e}Door`).subscribe(()=>{console.log("onEnter",`${e}Door`),console.log("has access",W[e].access),W[e].access?(console.log("access"),t()):(console.log("no access"),ke())}),WA.room.area.onLeave(`${e}Door`).subscribe(()=>{console.log("onLeave",`${e}Door`),W[e].access||(console.log("closeBanner"),xe())}),W[e].access||Ho(e)}function jo(){if(m.isEmployee()){let e;WA.room.area.onEnter("helicopterDoor").subscribe(()=>{e=WA.ui.displayActionMessage({message:"Press SPACE to fly to the BR Tower rooftop!",callback:async()=>{await ft()}})}),WA.room.area.onLeave("helicopterDoor").subscribe(async()=>{await(e==null?void 0:e.remove().then(()=>{e=null}))}),WA.room.area.onEnter("pickupDoor").subscribe(()=>{e=WA.ui.displayActionMessage({message:"Press SPACE to drive back to the BR Stadium!",callback:async()=>{await Y("town","from-tower")}})}),WA.room.area.onLeave("pickupDoor").subscribe(async()=>{await(e==null?void 0:e.remove().then(()=>{e=null}))})}}function Ho(e){console.log("lockWorldBuildingDoor",e);const t=W[e],s=w(t.blockingTiles[0],t.blockingTiles[1]).map(([n,r])=>({x:n,y:r,tile:"collision",layer:"collisions"}));WA.room.setTiles(s)}function Te(e){console.log("unlockWorldBuildingDoor",e),W[e].access=!0;const t=W[e],s=w(t.blockingTiles[0],t.blockingTiles[1]).map(([n,r])=>({x:n,y:r,tile:null,layer:"collisions"}));WA.room.setTiles(s)}function Xo(){console.log("tryToUnlockWorldBarriers()");const e=[];Object.entries(A).forEach(([t,o])=>{console.log("barrierName",t),o.access&&(console.log("has access"),w(o.blockingTiles[0],o.blockingTiles[1]).forEach(([n,r])=>{e.push({x:n,y:r,tile:null,layer:"walls/walls1"})}))}),WA.room.setTiles(e)}function I(e){A[e].access=!0;const t=A[e];console.log("barrierData",t);const o=w(t.blockingTiles[0],t.blockingTiles[1]);console.log("tilesCoordinates",o);const s=o.map(([n,r])=>({x:n,y:r,tile:null,layer:"walls/walls1"}));WA.room.setTiles(s)}function ut(){console.log("unlockAirportGate()"),J.access=!0;const o=w(J.turnstile[0],J.turnstile[1]).map(([s,n],r)=>({x:s,y:n,tile:`airport-turnstile-open-${r+1}`,layer:"furniture/furniture3"}));WA.room.setTiles(o)}function Ko(e){console.log("lockBrTowerFloorAccess()",e);const t=[],o=v[e],s={floor4:"walls/walls2",floor3:"tower/4",floor2:"tower/3",floor1:"tower/2",floor0:"tower/1",exit:"tower/0"},n=w(o.tilesCoordinates[0],o.tilesCoordinates[1]);n.forEach(([r,a])=>{t.push({x:r,y:a,tile:null,layer:s[e]})}),n.forEach(([r,a])=>{t.push({x:r,y:a,tile:e!=="floor4"?"br-tower-floor-wall":"br-tower-rooftop-closed",layer:s[e]})}),WA.room.setTiles(t)}function R(e){console.log("unlockBrTowerFloorAccess()",e);const t=[],o=v[e],s={floor4:"walls/walls2",floor3:"tower/4",floor2:"tower/3",floor1:"tower/2",floor0:"tower/1",exit:"tower/0"},n=w(o.tilesCoordinates[0],o.tilesCoordinates[1]);n.forEach(([r,a])=>{t.push({x:r,y:a,tile:null,layer:s[e]})}),n.forEach(([r,a],i)=>{t.push({x:r,y:a,tile:`${o.tilesNamePattern}-open-${i+1}`,layer:s[e]})}),WA.room.setTiles(t)}function qo(){Object.keys(v).forEach(e=>{v[e].access===!0?R(e):Ko(e)})}async function zo(){if(console.log("World script started successfully"),!c.canEnterCaveWorld()&&!m.isEmployee){console.log("Player can't access this room yet."),await Y("town");return}Yo()}function Yo(){for(let e=0;e<j.length-1;e++){const t=j[e],o=j[e+1];He(t,o)}for(let e=j.length-1;e>0;e--){const t=j[e],o=j[e-1];He(t,o)}}function He(e,t){WA.room.area.onEnter(`${e}-${t}`).subscribe(()=>{console.log("from",e),console.log("to",t),WA.nav.goToRoom(`#from-${e}-${t}`),WA.room.hideLayer(`tower/${e}`),Bo(e),WA.room.showLayer(`tower/${t}`),Io(t)})}async function ft(){console.log("disablePlayerControls"),WA.controls.disablePlayerControls(),await x(100),console.log("camera.set"),WA.camera.set(39*32,13*32,1e3,1e3,!0,!0),await x(100),console.log("displayHelicopterGIF"),await uo(),await x(100),console.log("player.teleport"),await WA.player.teleport(50*32,180*32),await x(100),console.log("removeAirportHelicopter"),Po(),await x(100),console.log("moveCameraToRooftop"),Qo(32*32,118*32,2e4),await x(2e4),console.log("LANDED"),console.log("placeRooftopHelicopter"),Eo(),await x(100),console.log("removeHelicopterGIF"),await fo(),await x(100),console.log("player.teleport"),await WA.player.teleport(27*32,116*32),await x(100),console.log("restorePlayerControls"),WA.controls.restorePlayerControls(),await x(100),WA.camera.followPlayer(!0)}function Qo(e,t,o){console.log("moveCameraToRooftop()"),WA.camera.set(e,t,1e3,1e3,!0,!0,o)}const _o="bedrock-journey",Zo=20;function Pe(e){go(e),bo(e)}function H(){console.log("========================"),console.log("placeNextJonasCheckpoint()");const e=c.getNextJonasCheckpointId(),t=D.find(o=>o.id===e);console.log("checkpoint",t),t&&(console.log("placeCheckpoint"),Pe(t))}async function ve(e){if(xe(),c.isCheckpointPassed(e))console.log("(State: unchanged) Old checkpoint passed",e);else{console.log("(State: update) New checkpoint passed",e),await it(!1),await c.addCheckpointId(e),await pt(c.getCheckpointXP(e)),await Ae.markCheckpointAsDone(e),await os(e);const t=Ae.getState();st(c.getNextCheckpointId(t))}}async function es(){if(WA.player.state.playerCameFromDoor===!0){console.log("Skip teleport: player naturally came from an exit of the other map");return}const e=c.getPassedCheckpointIdsOfMap();if(e.length===0){console.log("Skip teleport: player didn't pass any checkpoints on this map.");return}const t=e.pop(),o=D.find(s=>s.id===t);if(o){const{x:s,y:n}=o.spawn,r=s*32,a=n*32;console.log(`Teleport player to last checkpoint: ${o.id}`),await WA.player.teleport(r,a)}else console.warn("Skip teleport: Checkpoint not found.")}async function pt(e){console.log("grantQuestXP",e);try{await oo(_o,e)}catch(t){console.warn("Error while granting XP",t)}}function ts(){WA.player.state.onVariableChange("closeDialogueBoxEvent").subscribe(async e=>{const o=e.checkpoint;o&&(console.log('Variable "closeDialogueBoxEvent" changed. New value: ',o),o.url&&(console.log("Open URL",o.url),await ot(o.url)),o.npcName==="Jonas"?(await le(o.id),o.id==="32"||o.id==="36"?console.log("Don't move Jonas"):o.id==="23"?(console.log("Remove Jonas"),vo(o)):(console.log("Teleport Jonas"),Co(o.coordinates.x,o.coordinates.y))):o.type==="direction"&&(console.log("Remove direction area and tile"),await le(o.id),at(o)),console.log("checkpoint.id",o.id),await ve(o.id))})}async function os(e){switch(e){case"2":await rt();break;case"4":{const t=Uo();t?ct(t):ke();break}case"6":{const t=D.find(o=>o.id==="7");t&&Pe(t),H();break}case"7":Te("cave");break;case"9":I("achievements");break;case"10":I("values");break;case"11":I("legal");break;case"12":I("bridge");break;case"13":I("france"),H();break;case"14":case"15":c.canAccessHungary()&&I("hungary");break;case"16":case"17":c.canAccessBelgium()&&I("belgium");break;case"18":case"19":c.canAccessNetherlands()&&I("netherlands");break;case"20":case"21":c.canEnterAirport()&&Te("airport");break;case"22":ut();break;case"23":await ft(),console.log("TRAVEL FINISHED"),H();break;case"24":R("floor4"),H();break;case"25":R("floor3");break;case"26":R("floor2");break;case"27":R("floor1");break;case"28":R("floor0");break;case"29":R("exit");break;case"31":await x(1e3),H();break;case"32":await Y("town","from-tower");break;case"33":case"34":c.isBackstageDone()&&(H(),ee("backstage"),ee("arcade"),ee("streaming"),ee("wikitech"));break;case"39":case"40":case"41":c.isContentFRChecked()&&await ae();break;case"42":case"43":case"44":c.isContentPTChecked()&&await ae();break;case"45":case"46":case"47":c.isContentALTChecked()&&await ae();break;case"48":case"49":c.isContentEXTChecked()&&await ae();break}}async function ae(){await pt(Zo),co()}function ss(){console.log("Town script started successfully")}console.log("Main script started successfully");WA.onInit().then(()=>{console.log("*******************"),console.log("Scripting API ready"),WA.controls.disableInviteButton(),WA.controls.disableRightClick(),WA.controls.disableRoomList(),WA.controls.disableMapEditor(),L.initState(),m.initState(),z.initState(),to().then(async()=>{console.log("Scripting API Extra ready"),await c.initAsyncState(),ts(),m.hasMandatoryTags()?(await es(),je(),m.isOtherThanGuest()&&(lo(),io(),await rt(),L.isTown()?ss():L.isWorld()&&await zo())):(console.log("No player tag recognized."),L.isWorld()&&(console.log("Player can't access this room."),await Y("town")),je())}).catch(e=>console.error(e))}).catch(e=>console.error(e));
