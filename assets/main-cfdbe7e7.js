var dt=Object.defineProperty;var pt=(t,e,o)=>e in t?dt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var x=(t,e,o)=>(pt(t,typeof e!="symbol"?e+"":e,o),o);import{c as J,e as ht,a as yt,n as mt,b as bt,d as Pe}from"./Checkpoints-3b865f92.js";class H{constructor(e){this.properties=e??[]}get(e){const o=this.properties.filter(n=>n.name===e).map(n=>n.value);if(o.length>1)throw new Error('Expected only one property to be named "'+e+'"');if(o.length!==0)return o[0]}getString(e){return this.getByType(e,"string")}getNumber(e){return this.getByType(e,"number")}getBoolean(e){return this.getByType(e,"boolean")}getByType(e,o){const n=this.get(e);if(n!==void 0){if(o!=="json"&&typeof n!==o)throw new Error('Expected property "'+e+'" to have type "'+o+'"');return n}}mustGetString(e){return this.mustGetByType(e,"string")}mustGetNumber(e){return this.mustGetByType(e,"number")}mustGetBoolean(e){return this.mustGetByType(e,"boolean")}mustGetByType(e,o){const n=this.get(e);if(n===void 0)throw new Error('Property "'+e+'" is missing');if(o!=="json"&&typeof n!==o)throw new Error('Expected property "'+e+'" to have type "'+o+'"');return n}getType(e){const o=this.properties.filter(n=>n.name===e).map(n=>n.type);if(o.length>1)throw new Error('Expected only one property to be named "'+e+'"');if(o.length!==0)return o[0]}}const Xe="https://unpkg.com/@workadventure/scripting-api-extra@1.7.7/dist";class wt{constructor(e){this.name=e.name,this.x=e.x,this.y=e.y,this.properties=new H(e.properties)}get isReadable(){const e=this.properties.getString("readableBy");return e?WA.player.tags.includes(e):!0}get isWritable(){const e=this.properties.getString("writableBy");return e?WA.player.tags.includes(e):!0}}function Ee(t){const e=t?"#"+t.join():"";WA.nav.openCoWebSite(Xe+"/configuration.html"+e,!0)}async function At(t,e){const o=await WA.room.getTiledMap(),n=new Map;return ze(o.layers,n,t,e),n}function ze(t,e,o,n){for(const s of t)if(s.type==="objectgroup"){for(const r of s.objects)if(r.type==="variable"||r.class==="variable"){if(o&&s.name!==o||n&&!n.includes(r.name))continue;e.set(r.name,new wt(r))}}else s.type==="group"&&ze(s.layers,e,o,n)}let ie;async function _(){return ie===void 0&&(ie=vt()),ie}async function vt(){return Wt(await WA.room.getTiledMap())}function Wt(t){const e=new Map;return Ye(t.layers,"",e),e}function Ye(t,e,o){for(const n of t)n.type==="group"?Ye(n.layers,e+n.name+"/",o):(n.name=e+n.name,o.set(n.name,n))}async function qe(){const t=await _(),e=[];for(const o of t.values())if(o.type==="objectgroup")for(const n of o.objects)(n.type==="area"||n.class==="area")&&e.push(n);return e}function Tt(t){let e=1/0,o=1/0,n=0,s=0;const r=t.data;if(typeof r=="string")throw new Error("Unsupported tile layer data stored as string instead of CSV");for(let a=0;a<t.height;a++)for(let i=0;i<t.width;i++)r[i+a*t.width]!==0&&(e=Math.min(e,i),s=Math.max(s,i),o=Math.min(o,a),n=Math.max(n,a));return{top:o,left:e,right:s+1,bottom:n+1}}function Ke(t){let e=1/0,o=1/0,n=0,s=0;for(const r of t){const a=Tt(r);a.left<e&&(e=a.left),a.top<o&&(o=a.top),a.right>s&&(s=a.right),a.bottom>n&&(n=a.bottom)}return{top:o,left:e,right:s,bottom:n}}/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */var St=Object.prototype.toString,z=Array.isArray||function(e){return St.call(e)==="[object Array]"};function We(t){return typeof t=="function"}function Ct(t){return z(t)?"array":typeof t}function le(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Be(t,e){return t!=null&&typeof t=="object"&&e in t}function kt(t,e){return t!=null&&typeof t!="object"&&t.hasOwnProperty&&t.hasOwnProperty(e)}var xt=RegExp.prototype.test;function Pt(t,e){return xt.call(t,e)}var Et=/\S/;function Bt(t){return!Pt(Et,t)}var Lt={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function It(t){return String(t).replace(/[&<>"'`=\/]/g,function(o){return Lt[o]})}var Dt=/\s*/,Nt=/\s+/,Le=/\s*=/,Mt=/\s*\}/,$t=/#|\^|\/|>|\{|&|=|!/;function Rt(t,e){if(!t)return[];var o=!1,n=[],s=[],r=[],a=!1,i=!1,c="",u=0;function g(){if(a&&!i)for(;r.length;)delete s[r.pop()];else r=[];a=!1,i=!1}var h,S,te;function Y(P){if(typeof P=="string"&&(P=P.split(Nt,2)),!z(P)||P.length!==2)throw new Error("Invalid tags: "+P);h=new RegExp(le(P[0])+"\\s*"),S=new RegExp("\\s*"+le(P[1])),te=new RegExp("\\s*"+le("}"+P[1]))}Y(e||w.tags);for(var d=new Z(t),C,f,W,q,oe,I;!d.eos();){if(C=d.pos,W=d.scanUntil(h),W)for(var ae=0,gt=W.length;ae<gt;++ae)q=W.charAt(ae),Bt(q)?(r.push(s.length),c+=q):(i=!0,o=!0,c+=" "),s.push(["text",q,C,C+1]),C+=1,q===`
`&&(g(),c="",u=0,o=!1);if(!d.scan(h))break;if(a=!0,f=d.scan($t)||"name",d.scan(Dt),f==="="?(W=d.scanUntil(Le),d.scan(Le),d.scanUntil(S)):f==="{"?(W=d.scanUntil(te),d.scan(Mt),d.scanUntil(S),f="&"):W=d.scanUntil(S),!d.scan(S))throw new Error("Unclosed tag at "+d.pos);if(f==">"?oe=[f,W,C,d.pos,c,u,o]:oe=[f,W,C,d.pos],u++,s.push(oe),f==="#"||f==="^")n.push(oe);else if(f==="/"){if(I=n.pop(),!I)throw new Error('Unopened section "'+W+'" at '+C);if(I[1]!==W)throw new Error('Unclosed section "'+I[1]+'" at '+C)}else f==="name"||f==="{"||f==="&"?i=!0:f==="="&&Y(W)}if(g(),I=n.pop(),I)throw new Error('Unclosed section "'+I[1]+'" at '+d.pos);return Ot(Ft(s))}function Ft(t){for(var e=[],o,n,s=0,r=t.length;s<r;++s)o=t[s],o&&(o[0]==="text"&&n&&n[0]==="text"?(n[1]+=o[1],n[3]=o[3]):(e.push(o),n=o));return e}function Ot(t){for(var e=[],o=e,n=[],s,r,a=0,i=t.length;a<i;++a)switch(s=t[a],s[0]){case"#":case"^":o.push(s),n.push(s),o=s[4]=[];break;case"/":r=n.pop(),r[5]=s[2],o=n.length>0?n[n.length-1][4]:e;break;default:o.push(s)}return e}function Z(t){this.string=t,this.tail=t,this.pos=0}Z.prototype.eos=function(){return this.tail===""};Z.prototype.scan=function(e){var o=this.tail.match(e);if(!o||o.index!==0)return"";var n=o[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n};Z.prototype.scanUntil=function(e){var o=this.tail.search(e),n;switch(o){case-1:n=this.tail,this.tail="";break;case 0:n="";break;default:n=this.tail.substring(0,o),this.tail=this.tail.substring(o)}return this.pos+=n.length,n};function X(t,e){this.view=t,this.cache={".":this.view},this.parent=e}X.prototype.push=function(e){return new X(e,this)};X.prototype.lookup=function(e){var o=this.cache,n;if(o.hasOwnProperty(e))n=o[e];else{for(var s=this,r,a,i,c=!1;s;){if(e.indexOf(".")>0)for(r=s.view,a=e.split("."),i=0;r!=null&&i<a.length;)i===a.length-1&&(c=Be(r,a[i])||kt(r,a[i])),r=r[a[i++]];else r=s.view[e],c=Be(s.view,e);if(c){n=r;break}s=s.parent}o[e]=n}return We(n)&&(n=n.call(this.view)),n};function b(){this.templateCache={_cache:{},set:function(e,o){this._cache[e]=o},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}b.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};b.prototype.parse=function(e,o){var n=this.templateCache,s=e+":"+(o||w.tags).join(":"),r=typeof n<"u",a=r?n.get(s):void 0;return a==null&&(a=Rt(e,o),r&&n.set(s,a)),a};b.prototype.render=function(e,o,n,s){var r=this.getConfigTags(s),a=this.parse(e,r),i=o instanceof X?o:new X(o,void 0);return this.renderTokens(a,i,n,e,s)};b.prototype.renderTokens=function(e,o,n,s,r){for(var a="",i,c,u,g=0,h=e.length;g<h;++g)u=void 0,i=e[g],c=i[0],c==="#"?u=this.renderSection(i,o,n,s,r):c==="^"?u=this.renderInverted(i,o,n,s,r):c===">"?u=this.renderPartial(i,o,n,r):c==="&"?u=this.unescapedValue(i,o):c==="name"?u=this.escapedValue(i,o,r):c==="text"&&(u=this.rawValue(i)),u!==void 0&&(a+=u);return a};b.prototype.renderSection=function(e,o,n,s,r){var a=this,i="",c=o.lookup(e[1]);function u(S){return a.render(S,o,n,r)}if(c){if(z(c))for(var g=0,h=c.length;g<h;++g)i+=this.renderTokens(e[4],o.push(c[g]),n,s,r);else if(typeof c=="object"||typeof c=="string"||typeof c=="number")i+=this.renderTokens(e[4],o.push(c),n,s,r);else if(We(c)){if(typeof s!="string")throw new Error("Cannot use higher-order sections without the original template");c=c.call(o.view,s.slice(e[3],e[5]),u),c!=null&&(i+=c)}else i+=this.renderTokens(e[4],o,n,s,r);return i}};b.prototype.renderInverted=function(e,o,n,s,r){var a=o.lookup(e[1]);if(!a||z(a)&&a.length===0)return this.renderTokens(e[4],o,n,s,r)};b.prototype.indentPartial=function(e,o,n){for(var s=o.replace(/[^ \t]/g,""),r=e.split(`
`),a=0;a<r.length;a++)r[a].length&&(a>0||!n)&&(r[a]=s+r[a]);return r.join(`
`)};b.prototype.renderPartial=function(e,o,n,s){if(n){var r=this.getConfigTags(s),a=We(n)?n(e[1]):n[e[1]];if(a!=null){var i=e[6],c=e[5],u=e[4],g=a;c==0&&u&&(g=this.indentPartial(a,u,i));var h=this.parse(g,r);return this.renderTokens(h,o,n,g,s)}}};b.prototype.unescapedValue=function(e,o){var n=o.lookup(e[1]);if(n!=null)return n};b.prototype.escapedValue=function(e,o,n){var s=this.getConfigEscape(n)||w.escape,r=o.lookup(e[1]);if(r!=null)return typeof r=="number"&&s===w.escape?String(r):s(r)};b.prototype.rawValue=function(e){return e[1]};b.prototype.getConfigTags=function(e){return z(e)?e:e&&typeof e=="object"?e.tags:void 0};b.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!z(e))return e.escape};var w={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(t){Q.templateCache=t},get templateCache(){return Q.templateCache}},Q=new b;w.clearCache=function(){return Q.clearCache()};w.parse=function(e,o){return Q.parse(e,o)};w.render=function(e,o,n,s){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+Ct(e)+'" was given as the first argument for mustache#render(template, view, partials)');return Q.render(e,o,n,s)};w.escape=It;w.Scanner=Z;w.Context=X;w.Writer=b;class Qe{constructor(e,o){this.template=e,this.state=o,this.ast=w.parse(e)}getValue(){return this.value===void 0&&(this.value=w.render(this.template,this.state)),this.value}onChange(e){const o=[];for(const n of this.getUsedVariables().values())o.push(this.state.onVariableChange(n).subscribe(()=>{const s=w.render(this.template,this.state);s!==this.value&&(this.value=s,e(this.value))}));return{unsubscribe:()=>{for(const n of o)n.unsubscribe()}}}isPureString(){return this.ast.length===0||this.ast.length===1&&this.ast[0][0]==="text"}getUsedVariables(){const e=new Set;return this.recursiveGetUsedVariables(this.ast,e),e}recursiveGetUsedVariables(e,o){for(const n of e){const s=n[0],r=n[1],a=n[4];["name","&","#","^"].includes(s)&&o.add(r),a!==void 0&&typeof a!="string"&&this.recursiveGetUsedVariables(a,o)}}}async function Gt(){var t;const e=await qe();for(const o of e){const n=(t=o.properties)!==null&&t!==void 0?t:[];for(const s of n){if(s.type==="int"||s.type==="bool"||s.type==="object"||typeof s.value!="string")continue;const r=new Qe(s.value,WA.state);if(r.isPureString())continue;const a=r.getValue();await Ie(o.name,s.name,a),r.onChange(async i=>{await Ie(o.name,s.name,i)})}}}async function Vt(){var t;const e=await _();for(const[o,n]of e.entries())if(n.type!=="objectgroup"){const s=(t=n.properties)!==null&&t!==void 0?t:[];for(const r of s){if(r.type==="int"||r.type==="bool"||r.type==="object"||typeof r.value!="string")continue;const a=new Qe(r.value,WA.state);if(a.isPureString())continue;const i=a.getValue();De(o,r.name,i),a.onChange(c=>{De(o,r.name,c)})}}}async function Ie(t,e,o){console.log(t),(await WA.room.area.get(t)).setProperty(e,o)}function De(t,e,o){WA.room.setProperty(t,e,o),e==="visible"&&(o?WA.room.showLayer(t):WA.room.hideLayer(t))}const Jt="https://admin.workadventu.re/html";let ce,Te=0,Se=0;function Ne(t){if(WA.state[t.name]){let e=t.properties.mustGetString("openLayer");for(const o of e.split(`
`))WA.room.showLayer(o);e=t.properties.mustGetString("closeLayer");for(const o of e.split(`
`))WA.room.hideLayer(o)}else{let e=t.properties.mustGetString("openLayer");for(const o of e.split(`
`))WA.room.hideLayer(o);e=t.properties.mustGetString("closeLayer");for(const o of e.split(`
`))WA.room.showLayer(o)}}function jt(t){const e=t.properties.getString("openSound"),o=t.properties.getNumber("soundRadius");let n=1;if(o){const s=Ze(t.properties.mustGetString("openLayer").split(`
`));if(s>o)return;n=1-s/o}e&&WA.sound.loadSound(e).play({volume:n})}function Ut(t){const e=t.properties.getString("closeSound"),o=t.properties.getNumber("soundRadius");let n=1;if(o){const s=Ze(t.properties.mustGetString("closeLayer").split(`
`));if(s>o)return;n=1-s/o}e&&WA.sound.loadSound(e).play({volume:n})}function _e(t){return t.map(e=>ce.get(e)).filter(e=>(e==null?void 0:e.type)==="tilelayer")}function Ze(t){const e=_e(t),o=Ke(e),n=((o.right-o.left)/2+o.left)*32,s=((o.bottom-o.top)/2+o.top)*32;return Math.sqrt(Math.pow(Te-n,2)+Math.pow(Se-s,2))}function Ht(t){WA.state.onVariableChange(t.name).subscribe(()=>{WA.state[t.name]?jt(t):Ut(t),Ne(t)}),Ne(t)}function Me(t,e,o,n){const s=t.name;let r,a,i=!1;const c=o.getString("tag");let u=!0;c&&!WA.player.tags.includes(c)&&(u=!1);const g=!!c;function h(){var f;r&&r.remove(),r=WA.ui.displayActionMessage({message:(f=o.getString("closeTriggerMessage"))!==null&&f!==void 0?f:"Press SPACE to close the door",callback:()=>{WA.state[e.name]=!1,S()}})}function S(){var f;r&&r.remove(),r=WA.ui.displayActionMessage({message:(f=o.getString("openTriggerMessage"))!==null&&f!==void 0?f:"Press SPACE to open the door",callback:()=>{WA.state[e.name]=!0,h()}})}function te(){let f;if(t.type==="tilelayer")f=Ke(_e(e.properties.mustGetString("closeLayer").split(`
`)));else{if(t.x===void 0||t.y===void 0||t.width===void 0||t.height===void 0)throw new Error(`Doorstep zone "${t.name}" is missing x, y, width or height`);f={top:t.y,left:t.x,right:t.x+t.width,bottom:t.y+t.height}}a=WA.room.website.create({name:"doorKeypad"+s,url:n+"/keypad.html#"+encodeURIComponent(s),position:{x:f.right*32,y:f.top*32,width:32*3,height:32*4},allowApi:!0})}function Y(){a&&(WA.room.website.delete(a.name),a=void 0)}function d(){if(i=!0,o.getBoolean("autoOpen")&&u){WA.state[e.name]=!0;return}if(!WA.state[e.name]&&(g&&!u||!g)&&(o.getString("code")||o.getString("codeVariable"))){te();return}u&&(WA.state[e.name]?h():S())}function C(){i=!1,o.getBoolean("autoClose")&&(WA.state[e.name]=!1),r&&r.remove(),Y()}t.type==="tilelayer"?(WA.room.onEnterLayer(s).subscribe(d),WA.room.onLeaveLayer(s).subscribe(C)):(WA.room.area.onEnter(s).subscribe(d),WA.room.area.onLeave(s).subscribe(C)),WA.state.onVariableChange(e.name).subscribe(()=>{i&&(!o.getBoolean("autoClose")&&WA.state[e.name]===!0&&h(),a&&WA.state[e.name]===!0&&Y(),!o.getBoolean("autoOpen")&&WA.state[e.name]===!1&&S())})}function Xt(t){const e=t.properties.mustGetString("bellSound"),o=t.properties.getNumber("soundRadius");let n=1;if(o){const s=Math.sqrt(Math.pow(t.x-Te,2)+Math.pow(t.y-Se,2));if(s>o)return;n=1-s/o}WA.sound.loadSound(e).play({volume:n})}function zt(t){WA.state[t.name]===void 0&&(WA.state[t.name]=0),WA.state.onVariableChange(t.name).subscribe(()=>{WA.state[t.name]&&Xt(t)})}function $e(t,e,o){let n;const s=e.getString("bellPopup");if(o.type==="tilelayer"){const r=o.name;WA.room.onEnterLayer(r).subscribe(()=>{var a;s?n=WA.ui.openPopup(s,"",[{label:(a=e.getString("bellButtonText"))!==null&&a!==void 0?a:"Ring",callback:()=>{WA.state[t]=WA.state[t]+1}}]):WA.state[t]=WA.state[t]+1}),WA.room.onLeaveLayer(r).subscribe(()=>{n&&(n.close(),n=void 0)})}else{const r=o.name;WA.room.area.onEnter(r).subscribe(()=>{var a;s?n=WA.ui.openPopup(s,"",[{label:(a=e.getString("bellButtonText"))!==null&&a!==void 0?a:"Ring",callback:()=>{WA.state[t]=WA.state[t]+1}}]):WA.state[t]=WA.state[t]+1}),WA.room.area.onLeave(r).subscribe(()=>{n&&(n.close(),n=void 0)})}}async function Yt(t){t=t??Jt;const e=await At();ce=await _();for(const o of e.values())o.properties.get("door")&&Ht(o),o.properties.get("bell")&&zt(o);for(const o of ce.values()){const n=new H(o.properties),s=n.getString("doorVariable");if(s&&o.type==="tilelayer"){const a=e.get(s);if(a===void 0)throw new Error('Cannot find variable "'+s+'" referred in the "doorVariable" property of layer "'+o.name+'"');Me(o,a,n,t)}const r=n.getString("bellVariable");r&&o.type==="tilelayer"&&$e(r,n,o)}for(const o of await qe()){const n=new H(o.properties),s=n.getString("doorVariable");if(s){const a=e.get(s);if(a===void 0)throw new Error('Cannot find variable "'+s+'" referred in the "doorVariable" property of object "'+o.name+'"');Me(o,a,n,t)}const r=n.getString("bellVariable");r&&$e(r,n,o)}WA.player.onPlayerMove(o=>{Te=o.x,Se=o.y})}function qt(t,e){const o=t.getString("bindVariable");if(o){const n=t.get("enterValue"),s=t.get("leaveValue"),r=t.getString("triggerMessage"),a=t.getString("tag");Kt(o,e,n,s,r,a)}}function Kt(t,e,o,n,s,r){r&&!WA.player.tags.includes(r)||(o!==void 0&&WA.room.onEnterLayer(e).subscribe(()=>{s||(WA.state[t]=o)}),n!==void 0&&WA.room.onLeaveLayer(e).subscribe(()=>{WA.state[t]=n}))}async function Qt(){const t=await _();for(const e of t.values()){const o=new H(e.properties);qt(o,e.name)}}let Re;async function _t(t){const e=await WA.room.getTiledMap();t=t??Xe,Re=await _();const o=e.layers.find(n=>n.name==="configuration");if(o){const s=new H(o.properties).getString("tag");(!s||WA.player.tags.includes(s))&&WA.ui.registerMenuCommand("Configure the room",()=>{WA.nav.openCoWebSite(t+"/configuration.html",!0)});for(const r of Re.values()){const a=new H(r.properties),i=a.getString("openConfig");i&&r.type==="tilelayer"&&Zt(i.split(","),r.name,a)}}}function Zt(t,e,o){let n;const s=o.getString("openConfigAdminTag");let r=!0;s&&!WA.player.tags.includes(s)&&(r=!1);function a(){var c;n&&n.remove(),n=WA.ui.displayActionMessage({message:(c=o.getString("openConfigTriggerMessage"))!==null&&c!==void 0?c:"Press SPACE or touch here to configure",callback:()=>Ee(t)})}function i(){WA.nav.closeCoWebSite()}WA.room.onEnterLayer(e).subscribe(()=>{const c=o.getString("openConfigTrigger");r&&(c&&c==="onaction"?a():Ee(t))}),WA.room.onLeaveLayer(e).subscribe(()=>{n&&n.remove(),i()})}function eo(){return WA.onInit().then(()=>{Yt().catch(t=>console.error(t)),Qt().catch(t=>console.error(t)),_t().catch(t=>console.error(t)),Vt().catch(t=>console.error(t)),Gt().catch(t=>console.error(t))}).catch(t=>console.error(t))}let et="https://admin.workadventu.re";function tt(){const t=WA.player.userRoomToken;if(t===void 0)throw new Error("No userRoomToken found. The quests plugin can only work with WorkAdventure SAAS edition (at https://play.workadventu.re).");return t}async function to(t,e){if(!WA.player.isLogged)throw new Error("You must be logged to gain XP.");const o=new URL(`/api/quests/${t}/level-up`,et),n=await fetch(o,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:tt()},body:JSON.stringify({xp:e})});if(!n.ok)throw new Error(`An error occurred. HTTP Code: ${n.status} ${n.statusText}.`);const s=await n.json();return s.awardedBadges.length>0&&(async()=>{for(const r of s.awardedBadges)await oo(t,r)})().catch(r=>{console.error(r)}),s}async function oo(t,e){const o=new URL(`/quests/${t}/badge/${e}/congratulations`,et);o.search=new URLSearchParams({token:tt()}).toString(),await WA.ui.website.open({url:o.toString(),position:{vertical:"middle",horizontal:"middle"},allowApi:!0,visible:!0,size:{width:"100%",height:"100%"}})}const se="/@/bedrock-1710774685/onboardingbr/town",j=["ext","0","1","2","3","4","roof"],ot={roof:null,4:{x:31,y:124},3:{x:29,y:129},2:{x:29,y:137},1:{x:17,y:143},0:{x:28,y:150},ext:null},nt={roof:null,4:[[15,122],[21,122],[32,122],[18,124],[29,123],[30,123],[29,124],[30,124],[29,125],[30,125]],3:[[16,129],[17,129],[15,131],[16,131],[17,131],[18,131],[15,132],[16,132],[17,132],[18,132],[20,129],[20,130],[20,131],[28,130],[29,130],[30,130],[28,131],[29,131],[30,131],[28,132],[29,132],[30,132]],2:[[15,136],[16,136],[17,136],[18,136],[19,136],[20,136],[15,137],[16,137],[17,137],[18,137],[19,137],[20,137],[31,137]],1:[[16,144],[17,144],[16,145],[17,145],[19,144],[20,144],[19,145],[20,144],[19,145],[20,145],[27,144],[28,144],[27,145],[30,144],[31,144],[30,145],[31,145],[16,143],[16,146],[17,146],[20,146],[28,143],[28,146],[30,143],[30,146],[31,146]],0:[[16,150],[18,152],[19,152],[21,150],[26,150],[26,151],[27,151],[28,151],[29,151],[30,151],[31,151],[31,150],[32,150]],ext:null};class no{constructor(e){x(this,"state");x(this,"observers",[]);this.state=e}getState(){return this.state}setState(e){this.state=e,this.notifyObservers()}addObserver(e){this.observers.push(e)}notifyObservers(){this.observers.forEach(e=>e(this.state))}}const N=class N{constructor(){x(this,"state");this.state=new no({currentMap:"town",playerTags:[],rootUrl:"",checkpointIds:[],checklist:[]})}static getInstance(){return N.instance||(N.instance=new N),N.instance}getState(){return this.state.getState()}setState(e){this.state.setState(e)}subscribe(e){this.state.addObserver(e)}};x(N,"instance");let ue=N;const p=ue.getInstance(),M=class M{constructor(){}static getInstance(){return M.instance||(M.instance=new M),M.instance}getState(){return p.getState().checkpointIds}setState(e){const n={...p.getState(),checkpointIds:e};p.setState(n)}subscribe(e){p.subscribe(o=>{e(o.checkpointIds)})}async initAsyncState(){let e=await WA.player.state.checkpointIds;(!e||e.length<=1)&&(console.log("New player"),e=["0"]),console.log("initAsyncState checkpointIds",e),await this.setAsyncState(e)}async getAsyncState(){return this.getState()?this.getState():await WA.player.state.checkpointIds}async setAsyncState(e){this.setState(e),await WA.player.state.saveVariable("checkpointIds",e,{public:!1,persist:!0,ttl:48*3600,scope:"world"})}addCheckpointId(e){const o=this.getState();o.push(e),this.setState(o)}getNextCheckpointId(e){const o=e.find(n=>!n.done);return o?o.id:"-1"}getJonasCheckpointIds(){return J.filter(e=>(e==null?void 0:e.npcName)==="Jonas").map(e=>e.id)}getCheckpointXP(e){const o=J.find(n=>n.id===e);return o?o.xp:0}getNextJonasCheckpointId(){console.log("this.getJonasCheckpointIds()",this.getJonasCheckpointIds());const e=this.getState().map(Number),o=this.getJonasCheckpointIds().map(Number),n=Math.max(...e),s=o.find(r=>r>n);return console.log("next jonas",s!==void 0?s.toString():"-1"),s!==void 0?s.toString():"-1"}isCheckpointPassed(e){return this.getState().includes(e)}hasPlayerMetJonas(){return this.getState().includes("2")}isCheckpointAfterFirstJonas(e){return parseInt(e,10)>2}canEnterCaveWorld(){return this.getState().includes("4")}hasPlayerTalkedWithJonasInTheCave(){return this.getState().includes("6")}isCheckpointJonasPhone(e){return e==="7"}canLeaveCaveWorld(){return this.getState().includes("7")}canAccessAchievements(){return this.getState().includes("9")}canAccessValues(){return this.getState().includes("10")}canAccessLegal(){return this.getState().includes("11")}canAccessBridge(){return this.getState().includes("12")}canAccessFrance(){return this.getState().includes("13")}canAccessHungary(){return["14","15"].every(e=>this.getState().includes(e))}canAccessBelgium(){return["16","17"].every(e=>this.getState().includes(e))}canAccessNetherlands(){return["18","19"].every(e=>this.getState().includes(e))}canEnterAirport(){return["20","21"].every(e=>this.getState().includes(e))}canEnterAirportGates(){return this.getState().includes("22")}canEnterBRTower(){return this.getState().includes("24")}isCheckpointInBrTower(e){const o=parseInt(e,10);return 25<=o&&o<=29}canEnterBRTowerFloor3(){return this.getState().includes("25")}canEnterBRTowerFloor2(){return this.getState().includes("26")}canEnterBRTowerFloor1(){return this.getState().includes("27")}canEnterBRTowerFloor0(){return this.getState().includes("28")}canLeaveBRTower(){return this.getState().includes("29")}isWorldMapDone(){return this.getState().includes("32")}canLeaveBackstage(){return["33","34"].every(e=>this.getState().includes(e))}isOnboardingDone(){return this.getState().includes("34")}isCheckpointAfterOnboarding(e){return parseInt(e,10)>32}};x(M,"instance");let fe=M;const l=fe.getInstance(),$=class ${constructor(){}static getInstance(){return $.instance||($.instance=new $),$.instance}getState(){return p.getState().playerTags}setState(e){const n={...p.getState(),playerTags:e};p.setState(n)}subscribe(e){p.subscribe(o=>{e(o.playerTags)})}initState(){this.setState(WA.player.tags)}hasMandatoryTags(){return this.getState().some(o=>ht.includes(o))}hasMandatoryTagsIn(e){return this.getState().some(n=>e.includes(n))}isAdmin(){return this.getState().some(o=>o==="admin")}isEmployee(){return this.getState().some(o=>yt.includes(o))}isHr(){return this.getState().some(o=>["admin","hr"].includes(o))}isNewbie(){return this.getState().some(o=>mt.includes(o))}hasFrProfile(){return this.getState().some(o=>o==="fr")}hasPtProfile(){return this.getState().some(o=>o==="pt")}hasAltProfile(){return this.getState().some(o=>o==="alt")}hasExtProfile(){return this.getState().some(o=>o==="ext")}isGuest(){return this.getState().some(o=>o==="guest")}isOtherThanGuest(){return this.getState().some(o=>bt.includes(o))}};x($,"instance");let ge=$;const y=ge.getInstance();async function k(t){return new Promise(e=>{setTimeout(()=>{e()},t)})}function so(t){return typeof t!="string"?!1:t.startsWith("http")}const R=class R{constructor(){}static getInstance(){return R.instance||(R.instance=new R),R.instance}getState(){return p.getState().rootUrl}setState(e){const n={...p.getState(),rootUrl:e};p.setState(n)}subscribe(e){p.subscribe(o=>{e(o.rootUrl)})}initState(){const e=WA.room.mapURL,o=e.substring(0,e.lastIndexOf("/"));this.setState(o)}};x(R,"instance");let de=R;const ee=de.getInstance(),Ce="The door is locked. You are not qualified to enter here.";let pe,he,ne;async function Fe(t){console.log("openDialogueBox");const e=ee.getState();pe=await WA.ui.website.open({url:e+`/dialogue-box/index.html?id=${t}`,visible:!0,allowApi:!0,allowPolicy:"",position:{vertical:"bottom",horizontal:"middle"},size:{height:"120px",width:"650px"},margin:{bottom:"70px"}})}async function Oe(){pe&&await pe.close()}async function st(t,e=!1){const o=ee.getState(),n=so(t)?t:`${o}/content/${t}`;ne=await WA.nav.openCoWebSite(n,!1,"accelerometer; autoplay; camera; encrypted-media; gyroscope; picture-in-picture",70,1,e,!1)}async function Ge(){console.log("coWebsite"),ne&&(console.log("coWebsite",ne),await ne.close())}function rt(t){if(console.log("Display banner of checkpoint",t),t==="-1"){WA.ui.banner.openBanner({id:"onboarding-banner",text:"CONGRATULATIONS! YOU HAVE SUCCESSFULLY FINISHED THE ONBOARDING AND COMPLETED ALL CHECKPOINTS!",bgColor:"#3402F0",textColor:"#FFFFFF",closable:!1,timeToClose:12e4});return}const e=J.find(o=>o.id===t);e&&WA.ui.banner.openBanner({id:"onboarding-banner",text:`${e.title}: ${e.description}`,bgColor:"#3402F0",textColor:"#FFFFFF",closable:!1,timeToClose:12e4})}function ke(t){WA.ui.banner.openBanner({id:"onboarding-banner",text:t,bgColor:"#FD4D26",textColor:"#FFFFFF",closable:!0,timeToClose:3e3})}function xe(){WA.ui.banner.closeBanner()}function ro(){const t=ee.getState();WA.ui.actionBar.addButton({id:"checklist-btn",type:"action",imageSrc:`${t}/checklist-icon.svg`,toolTip:"Onboarding Checklist",callback:()=>{WA.ui.modal.openModal({title:"Plan",src:`${t}/checklist/index.html`,allowApi:!0,allow:"microphone; camera",position:"center"},()=>WA.ui.modal.closeModal())}})}async function ao(){const t=ee.getState();he=await WA.ui.website.open({url:`${t}/helicopter.gif`,visible:!0,allowApi:!1,allowPolicy:"",position:{vertical:"middle",horizontal:"middle"},size:{height:"500px",width:"500px"}})}async function io(){he&&await he.close()}function A(t,e){const o=[],[n,s]=t,[r,a]=e;for(let i=s;i<=a;i++)for(let c=n;c<=r;c++)o.push([c,i]);return o}function lo(t){t.type==="NPC"?co(t):t.type==="content"?uo(t):t.type==="direction"?po(t):console.error("Invalid area type while placing tile")}function co(t){if(console.log(`Placing checkpoint ${t.id} (NPC tile)`),t.npcName&&t.npcSprite){const e=t.npcName.toLowerCase();WA.room.setTiles([{x:t.coordinates.x,y:t.coordinates.y,tile:`npc-${e}-${t.npcSprite}`,layer:l.isCheckpointInBrTower(t.id)?"tower/content":"furniture/furniture3"}])}}function uo(t){console.log(`Placing checkpoint ${t.id} (content tile)`),WA.room.setTiles([{x:t.coordinates.x,y:t.coordinates.y,tile:"content",layer:l.isCheckpointInBrTower(t.id)?"tower/content":"furniture/furniture1"}]),l.isCheckpointJonasPhone(t.id)&&WA.room.setTiles([{x:t.coordinates.x,y:t.coordinates.y,tile:"smartphone",layer:"furniture/furniture2"}])}function fo(t){WA.room.setTiles([{x:t.coordinates.x,y:t.coordinates.y,tile:null,layer:l.isCheckpointInBrTower(t.id)?"tower/content":"furniture/furniture3"}])}async function go(t){WA.room.setTiles([{x:t.coordinates.x,y:t.coordinates.y,tile:null,layer:l.isCheckpointInBrTower(t.id)?"tower/content":"furniture/furniture1"}]),l.isCheckpointJonasPhone(t.id)&&(await WA.room.area.delete(t.id),WA.room.setTiles([{x:t.coordinates.x,y:t.coordinates.y,tile:null,layer:"furniture/furniture2"}]))}function po(t){console.log(`Placing checkpoint ${t.id} (direction tile)`),WA.room.setTiles([{x:t.coordinates.x,y:t.coordinates.y,tile:"direction",layer:"furniture/furniture1"}])}function at(t){WA.room.setTiles([{x:t.coordinates.x,y:t.coordinates.y,tile:null,layer:"furniture/furniture1"}])}function ho(t,e){yo(t,e),mo(t,e)}function yo(t,e){WA.room.setTiles([{x:t,y:e,tile:"npc-jonas-tp",layer:"furniture/furniture3"}]),setTimeout(()=>{WA.room.setTiles([{x:t,y:e,tile:null,layer:"furniture/furniture3"}])},1e3)}function mo(t,e){const r=[{dx:-1,dy:-1,id:1},{dx:0,dy:-1,id:2},{dx:1,dy:-1,id:3},{dx:-1,dy:0,id:4},{dx:0,dy:0,id:5},{dx:1,dy:0,id:6},{dx:-1,dy:1,id:7},{dx:0,dy:1,id:8},{dx:1,dy:1,id:9}],a=r.map(({dx:i,dy:c,id:u})=>({x:t+i,y:e+c,tile:`teleport-${u}`,layer:"above/above1"}));WA.room.setTiles(a),setTimeout(()=>{const i=r.map(({dx:c,dy:u})=>({x:t+c,y:e+u,tile:null,layer:"above/above1"}));WA.room.setTiles(i)},1800)}function bo(){const t=A([34,10],[40,14]),e=t.map(([n,s])=>({x:n,y:s,tile:null,layer:"furniture/furniture1"})),o=t.map(([n,s])=>({x:n,y:s,tile:null,layer:"above/above1"}));WA.room.setTiles([...e,...o])}function wo(){console.log("placeRooftopHelicopter()");const e=A([26,114],[32,118]).map(([o,n],s)=>({x:o,y:n,tile:`helicopter-landed-${s+1}`,layer:"above/above1"}));WA.room.setTiles(e)}function Ao(t){const e=[],o=ot[t];o!==null&&(console.log("place content tile on coordinates",o),e.push({x:o.x,y:o.y,tile:`hide-checkpoint-floor-${t}`,layer:"above/above2"}));const n=nt[t];n!==null&&(console.log("remove collision tiles on coordinates",n),n.forEach(([s,r])=>{e.push({x:s,y:r,tile:null,layer:"collisions"})})),WA.room.setTiles(e)}function vo(t){const e=[],o=ot[t];o!==null&&(console.log("remove content tile on coordinates",o),e.push({x:o.x,y:o.y,tile:null,layer:"above/above2"}));const n=nt[t];n!==null&&(console.log("add collision tiles on coordinates",n),n.forEach(([s,r])=>{e.push({x:s,y:r,tile:"collision",layer:"collisions"})})),WA.room.setTiles(e)}function Wo(){if(console.log("World script started successfully"),!l.canEnterCaveWorld()&&!y.isEmployee){console.log("Player can't access this room yet."),WA.nav.goToRoom(se);return}To()}function To(){for(let t=0;t<j.length-1;t++){const e=j[t],o=j[t+1];Ve(e,o)}for(let t=j.length-1;t>0;t--){const e=j[t],o=j[t-1];Ve(e,o)}}function Ve(t,e){WA.room.area.onEnter(`${t}-${e}`).subscribe(()=>{WA.nav.goToRoom(`#from-${t}-${e}`),WA.room.hideLayer(`tower/${t}`),Ao(t),WA.room.showLayer(`tower/${e}`),vo(e)})}async function it(){console.log("disablePlayerControls"),WA.controls.disablePlayerControls(),await k(100),console.log("camera.set"),WA.camera.set(39*32,13*32,1e3,1e3,!0,!0),await k(100),console.log("displayHelicopterGIF"),await ao(),await k(100),console.log("player.teleport"),await WA.player.teleport(50*32,180*32),await k(100),console.log("removeAirportHelicopter"),bo(),await k(100),console.log("moveCameraToRooftop"),So(32*32,118*32,2e3),await k(2e3),console.log("LANDED"),console.log("placeRooftopHelicopter"),wo(),await k(100),console.log("removeHelicopterGIF"),await io(),await k(100),console.log("player.teleport"),await WA.player.teleport(27*32,116*32),await k(100),console.log("restorePlayerControls"),WA.controls.restorePlayerControls(),await k(100),WA.camera.followPlayer(!0)}function So(t,e,o){console.log("moveCameraToRooftop()"),window.parent.postMessage({type:"cameraSet",data:{x:t,y:e,width:1e3,height:1e3,lock:!0,smooth:!0,duration:o}},"*")}const F=class F{constructor(){}static getInstance(){return F.instance||(F.instance=new F),F.instance}getState(){return p.getState().checklist}setState(e){const n={...p.getState(),checklist:e};p.setState(n)}subscribe(e){p.subscribe(o=>{e(o.checklist)})}async getAsyncState(){return console.log("getAsyncState",this.getState()?this.getState():await WA.player.state.checklist),this.getState()?this.getState():await WA.player.state.checklist}async setAsyncState(e){console.log("setAsyncState",e),this.setState(e),await WA.player.state.saveVariable("checklist",e,{public:!1,persist:!0,ttl:48*3600,scope:"world"})}async markCheckpointAsDone(e){const o=await this.getAsyncState(),n=o.findIndex(s=>s.id===e);o[n].done=n!==-1,await this.setAsyncState(o)}};x(F,"instance");let ye=F;const me=ye.getInstance(),O=class O{constructor(){}static getInstance(){return O.instance||(O.instance=new O),O.instance}getState(){return p.getState().currentMap}setState(e){const n={...p.getState(),currentMap:e};p.setState(n)}subscribe(e){p.subscribe(o=>{e(o.currentMap)})}initState(){this.setState(WA.state.map)}isTown(){return this.getState()==="town"}isWorld(){return this.getState()==="world"}};x(O,"instance");let be=O;const G=be.getInstance();let Je=!1;async function lt(){const t=[];console.log("Processing areas..."),J.forEach(o=>{ct(o)&&(t.push({id:o.id,title:o.title,done:l.isCheckpointPassed(o.id)}),xo(o)&&Po(o)&&Eo(o)&&re(o))}),await me.setAsyncState(t);const e=l.getNextCheckpointId(t);rt(e)}function Co(){console.log("Processing areas after on boarding..."),console.log("checkpointIdsAfterOnboarding",Pe),Pe.forEach(t=>{const e=J.find(o=>o.id===t);e&&ct(e)&&(l.isCheckpointPassed(t)||re(e))})}function ko(t){console.log(`Placing checkpoint ${t.id} (area)`);const e=32,o=128,n=t.coordinates.x*e,s=t.coordinates.y*e,r=n-(o-e)/2,a=s-(o-e)/2;WA.room.area.create({name:t.id,x:r,y:a,width:o,height:o}),WA.room.area.onEnter(t.id).subscribe(async()=>{console.log("Entered checkpoint area",t.id),t.type==="NPC"&&t.message?await Fe(t.id):t.type==="content"&&t.url?await st(t.url):t.type==="direction"&&t.message&&await Fe(t.id)}),WA.room.area.onLeave(t.id).subscribe(async()=>{console.log("Leaved checkpoint area",t.id),t.type==="NPC"?(await Oe(),t.url&&await Ge()):t.type==="content"?(await Ge(),await go(t),await ve(t.id)):t.type==="direction"&&(t.message?await Oe():(await WA.room.area.delete(t.id),at(t),await ve(t.id)))})}function xo(t){const e=t.id;return G.getState()!==t.map?(console.log(`Ignoring checkpoint ${e} (not the right map)`),!1):!0}function ct(t){const e=t.id,o=t.tags;return console.log("Filter checkpoint: ",t.title),o&&!y.hasMandatoryTagsIn(o)?(console.log(`Ignoring checkpoint ${e} (not the right tags)`),!1):!0}function Po(t){const e=t.id;return l.isCheckpointJonasPhone(e)&&(!l.hasPlayerTalkedWithJonasInTheCave()||l.canLeaveCaveWorld())?(console.log(`Ignoring checkpoint ${e} (milestone Jonas phone)`),!1):l.isCheckpointAfterFirstJonas(e)&&!l.hasPlayerMetJonas()?(console.log(`Ignoring checkpoint ${e} (milestone meet Jonas)`),!1):l.isCheckpointAfterOnboarding(e)&&!l.isWorldMapDone()?(console.log(`Ignoring checkpoint ${e} (milestone onboarding)`),!1):!0}function Eo(t){const e=t.id;if(l.isCheckpointPassed(e)){if(t.type==="NPC"&&t.npcName==="Jonas")return console.log(`Ignoring checkpoint ${e} (already met this Jonas)`),!1;if(t.type==="direction")return console.log(`Ignoring checkpoint ${e} (already passed this direction)`),!1}else if(t.type==="NPC"&&t.npcName==="Jonas"){if(Je)return console.log(`Ignoring checkpoint ${e} (next Jonas is already placed)`),!1;Je=!0}return!0}function je(){G.isTown()?Bo():G.isWorld()&&$o()}const m={hr:{access:!0,blockingTiles:[[80,74],[83,74]]},arcade:{access:!1,blockingTiles:[[16,116],[19,116]]},stadium:{access:!1,blockingTiles:[[18,77],[20,77]]},wikitek:{access:!1,blockingTiles:[[77,110],[82,110]]},streaming:{access:!1,blockingTiles:[[69,40],[72,40]]},cave:{access:!1,blockingTiles:[[49,11],[50,11]]},backstage:{access:!1,blockingTiles:[[29,49],[30,51]]},service:{access:!1,blockingTiles:[[10,39],[12,41]]}},E={alt:{access:!1,leftWall:[[41,4],[41,5]],rightWall:[[44,4],[44,5]],pillar:[[42,5],[43,6]]},fr:{access:!1,leftWall:[[45,2],[45,3]],rightWall:[[48,2],[48,3]],pillar:[[46,3],[47,4]]},ext:{access:!1,leftWall:[[50,2],[50,3]],rightWall:[[53,2],[53,3]],pillar:[[51,3],[52,4]]},pt:{access:!1,leftWall:[[54,4],[54,5]],rightWall:[[57,4],[57,5]],pillar:[[55,5],[56,6]]}},V={hrMeetingDoor1:{access:!1,tilesNamePattern:"hr-meeting-door",tilesCoordinates:[[71,62],[72,63]]},hrMeetingDoor2:{access:!1,tilesNamePattern:"hr-meeting-door",tilesCoordinates:[[76,62],[77,63]]},hrMeetingDoor3:{access:!1,tilesNamePattern:"hr-meeting-door",tilesCoordinates:[[88,62],[89,63]]},hrMeetingDoor4:{access:!1,tilesNamePattern:"hr-meeting-door",tilesCoordinates:[[93,62],[94,63]]}};function Bo(){if(y.isGuest())Object.keys(m).forEach(t=>{m[t].access=t==="hr"||t==="arcade"});else if(y.isOtherThanGuest()){const t=l.isOnboardingDone();m.stadium.access=!0,m.cave.access=!0,m.hr.access=!0,m.service.access=l.isWorldMapDone(),m.arcade.access=t,m.streaming.access=t,m.wikitek.access=t,m.backstage.access=t,l.canEnterCaveWorld()&&(E.fr.access=y.hasFrProfile(),E.pt.access=y.hasPtProfile(),E.alt.access=y.hasAltProfile(),E.ext.access=y.hasExtProfile()),y.isEmployee()&&(console.log("Open all town doors"),Object.keys(m).forEach(e=>{m[e].access=!0}),E.fr.access=!0)}for(const t in m)Lo(t);for(const t in V)Io(t);No(),console.log("townBuildings",m),console.log("townCaveProfileDoors",E),console.log("hrMeetingDoors",V)}function Lo(t){let e=!0;m[t].access?t==="service"?WA.room.area.onEnter(`${t}Door`).subscribe(()=>{console.log("listenTownDoor() onEnter"),we(t),e===!0?(e=!1,WA.room.hideLayer("roofs/backstage1"),WA.room.hideLayer("roofs/stadium1")):(e=!0,WA.room.showLayer("roofs/backstage1"),WA.room.showLayer("roofs/stadium1"))}):WA.room.area.onEnter(`${t}Door`).subscribe(()=>{console.log("listenTownDoor() onEnter"),we(t),e===!0?(e=!1,WA.room.hideLayer(`roofs/${t}1`),WA.room.hideLayer(`roofs/${t}2`)):(e=!0,WA.room.showLayer(`roofs/${t}1`),WA.room.showLayer(`roofs/${t}2`))}):(Do(t),WA.room.area.onEnter(`${t}Door`).subscribe(()=>{ke(Ce)}),WA.room.area.onLeave(`${t}Door`).subscribe(()=>{xe()}))}function Io(t){let e;Ue(t),y.isHr()&&(WA.room.area.onEnter(t).subscribe(()=>{e=WA.ui.displayActionMessage({message:`Press SPACE to ${V[t].access?"close":"open"} the door`,callback:async()=>{await WA.state.saveVariable(`${t}Variable`,!V[t].access)}})}),WA.room.area.onLeave(t).subscribe(async()=>{await(e==null?void 0:e.remove().then(()=>{e=null}))})),WA.state.onVariableChange(`${t}Variable`).subscribe(o=>{V[t].access=o,Ue(t)})}function Ue(t){console.log("TOGGLE",t);const e=V[t],o=A(e.tilesCoordinates[0],e.tilesCoordinates[1]),n=`${e.tilesNamePattern}-${V[t].access?"open":"closed"}`,s=o.map(([r,a],i)=>({x:r,y:a,tile:`${n}-${i+1}`,layer:"furniture/furniture2"}));WA.room.setTiles(s)}function Do(t){const e=m[t],n=A(e.blockingTiles[0],e.blockingTiles[1]).map(([s,r])=>({x:s,y:r,tile:"collision",layer:"collisions"}));WA.room.setTiles(n)}function we(t){const e=m[t],n=A(e.blockingTiles[0],e.blockingTiles[1]).map(([s,r])=>({x:s,y:r,tile:null,layer:"collisions"}));WA.room.setTiles(n)}function No(){Object.keys(E).forEach(t=>{E[t].access===!0&&ut(t)})}function ut(t){const e=E[t],o=A(e.pillar[0],e.pillar[1]),n=A(e.leftWall[0],e.leftWall[1]),s=A(e.rightWall[0],e.rightWall[1]),r=o.map(([u,g],h)=>({x:u,y:g,tile:`no-pillar-${h+1}`,layer:"walls/walls1"})),a=n.map(([u,g],h)=>({x:u,y:g,tile:`cave-door-wall-open-${h+1}`,layer:"walls/walls1"})),i=s.map(([u,g],h)=>({x:u,y:g,tile:`cave-door-wall-open-${h+1}`,layer:"walls/walls1"})),c=[...r,...a,...i];WA.room.setTiles(c)}function Mo(){let t=null;return y.hasFrProfile()?t="fr":y.hasAltProfile()?t="alt":y.hasExtProfile()?t="ext":y.hasPtProfile()&&(t="pt"),t}const L={cave:{access:!1,blockingTiles:[[29,181],[29,182]]},airport:{access:!1,blockingTiles:[[51,22],[53,22]]}},v={achievements:{access:!0,blockingTiles:[[84,168],[87,168]]},values:{access:!0,blockingTiles:[[61,159],[61,163]]},legal:{access:!0,blockingTiles:[[37,107],[37,111]]},bridge:{access:!0,blockingTiles:[[18,83],[22,83]]},france:{access:!0,blockingTiles:[[19,67],[21,67]]},hungary:{access:!0,blockingTiles:[[72,48],[72,52]]},belgium:{access:!0,blockingTiles:[[102,23],[106,23]]},netherlands:{access:!0,blockingTiles:[[70,30],[70,34]]}},U={access:!1,turnstile:[[52,11],[52,12]],lightsY:[[52,6],[52,10]],lightsX:[[48,5],[52,5]]},T={floor4:{access:!1,tilesNamePattern:"rooftop-to-floor4",tilesCoordinates:[[23,117],[23,117]]},floor3:{access:!1,tilesNamePattern:"floor4-to-floor3",tilesCoordinates:[[22,126],[25,126]]},floor2:{access:!1,tilesNamePattern:"floor3-to-floor2",tilesCoordinates:[[22,133],[25,133]]},floor1:{access:!1,tilesNamePattern:"floor2-to-floor1",tilesCoordinates:[[22,140],[25,140]]},floor0:{access:!1,tilesNamePattern:"floor1-to-floor0",tilesCoordinates:[[22,147],[25,147]]},exit:{access:!1,tilesNamePattern:"floor0-to-exit",tilesCoordinates:[[22,154],[25,154]]}};function $o(){L.cave.access=l.canLeaveCaveWorld(),L.airport.access=l.canEnterAirport(),v.achievements.access=l.canAccessAchievements(),v.values.access=l.canAccessValues(),v.legal.access=l.canAccessLegal(),v.bridge.access=l.canAccessBridge(),v.france.access=l.canAccessFrance(),v.hungary.access=l.canAccessHungary(),v.belgium.access=l.canAccessBelgium(),v.netherlands.access=l.canAccessNetherlands(),U.access=l.canEnterAirportGates(),T.floor4.access=l.canEnterBRTower(),T.floor3.access=l.canEnterBRTowerFloor3(),T.floor2.access=l.canEnterBRTowerFloor2(),T.floor1.access=l.canEnterBRTowerFloor1(),T.floor0.access=l.canEnterBRTowerFloor0(),T.exit.access=l.canLeaveBRTower(),y.isEmployee()&&(console.log("Open all world doors"),Object.keys(L).forEach(t=>{L[t].access=!0}),Object.keys(v).forEach(t=>{v[t].access=!0}),U.access=!0,Object.keys(T).forEach(t=>{T[t].access=!0})),He("cave"),He("airport"),Ro(),Oo(),U.access&&ft(),Go(),console.log("worldBuildings",L),console.log("worldBarriers",v),console.log("airportGate",U),console.log("brTowerFloors",T)}function He(t){let e=t!=="cave";L[t].access?WA.room.area.onEnter(`${t}Door`).subscribe(()=>{console.log("listenWorldDoor() onEnter"),Ae(t),e===!0?(e=!1,WA.room.hideLayer(`roofs/${t}1`)):(e=!0,WA.room.showLayer(`roofs/${t}1`))}):(Fo(t),WA.room.area.onEnter(`${t}Door`).subscribe(()=>{ke(Ce)}),WA.room.area.onLeave(`${t}Door`).subscribe(()=>{xe()}))}function Ro(){if(y.isEmployee()){let t;WA.room.area.onEnter("helicopterDoor").subscribe(()=>{t=WA.ui.displayActionMessage({message:"Press SPACE to fly to the BR Tower rooftop!",callback:async()=>{await it()}})}),WA.room.area.onLeave("helicopterDoor").subscribe(async()=>{await(t==null?void 0:t.remove().then(()=>{t=null}))}),WA.room.area.onEnter("pickupDoor").subscribe(()=>{t=WA.ui.displayActionMessage({message:"Press SPACE to drive back to the BR Stadium!",callback:()=>{WA.nav.goToRoom(`${se}#from-tower`)}})}),WA.room.area.onLeave("pickupDoor").subscribe(async()=>{await(t==null?void 0:t.remove().then(()=>{t=null}))})}}function Fo(t){const e=L[t],n=A(e.blockingTiles[0],e.blockingTiles[1]).map(([s,r])=>({x:s,y:r,tile:"collision",layer:"collisions"}));WA.room.setTiles(n)}function Ae(t){const e=L[t],n=A(e.blockingTiles[0],e.blockingTiles[1]).map(([s,r])=>({x:s,y:r,tile:null,layer:"collisions"}));WA.room.setTiles(n)}function Oo(){console.log("unlockWorldBarriers()");const t=[];Object.entries(v).forEach(([e,o])=>{console.log("barrierName",e),o.access&&(console.log("has access"),A(o.blockingTiles[0],o.blockingTiles[1]).forEach(([s,r])=>{t.push({x:s,y:r,tile:null,layer:"walls/walls1"})}))}),WA.room.setTiles(t)}function B(t){const e=v[t];console.log("barrierData",e);const o=A(e.blockingTiles[0],e.blockingTiles[1]);console.log("tilesCoordinates",o);const n=o.map(([s,r])=>({x:s,y:r,tile:null,layer:"walls/walls1"}));WA.room.setTiles(n)}function ft(){console.log("unlockAirportGate()");const o=A(U.turnstile[0],U.turnstile[1]).map(([n,s],r)=>({x:n,y:s,tile:`airport-turnstile-open-${r+1}`,layer:"furniture/furniture3"}));WA.room.setTiles(o)}function D(t){console.log("unlockBrTowerFloorAccess()");const e=[],o=T[t],n={floor4:"walls/walls2",floor3:"tower/4",floor2:"tower/3",floor1:"tower/2",floor0:"tower/1",exit:"tower/0"},s=A(o.tilesCoordinates[0],o.tilesCoordinates[1]);s.forEach(([r,a])=>{e.push({x:r,y:a,tile:null,layer:n[t]})}),s.forEach(([r,a],i)=>{e.push({x:r,y:a,tile:`${o.tilesNamePattern}-open-${i+1}`,layer:n[t]})}),WA.room.setTiles(e)}function Go(){Object.keys(T).forEach(t=>{T[t].access===!0&&D(t)})}const Vo="bedrock-journey";function re(t){ko(t),lo(t)}function K(){const t=l.getNextJonasCheckpointId(),e=J.find(o=>o.id===t);e&&re(e)}async function ve(t){if(xe(),l.isCheckpointPassed(t))console.log("(State: unchanged) Old checkpoint passed",t);else{console.log("(State: update) New checkpoint passed",t),l.addCheckpointId(t),await Jo(l.getCheckpointXP(t)),await me.markCheckpointAsDone(t),await Uo(t);const e=await me.getAsyncState();rt(l.getNextCheckpointId(e))}}async function Jo(t){console.log("grantQuestXP",t);try{await to(Vo,t)}catch(e){console.error("Error while granting XP",e)}}function jo(){WA.player.state.onVariableChange("closeDialogueBoxEvent").subscribe(async t=>{const e=t;e&&(console.log('Variable "closeDialogueBoxEvent" changed. New value: ',e),e.url&&(console.log("Open URL",e.url),await st(e.url,e.npcName==="Jonas")),e.npcName==="Jonas"?(await WA.room.area.delete(e.id),e.id==="32"||e.id==="36"?console.log("Don't move Jonas"):e.id==="23"?(console.log("Remove Jonas"),fo(e)):(console.log("Teleport Jonas"),ho(e.coordinates.x,e.coordinates.y))):e.type==="direction"&&(console.log("Remove direction area and tile"),await WA.room.area.delete(e.id),at(e)),console.log("checkpoint.id",e.id),await ve(e.id))})}async function Uo(t){switch(t){case"2":await lt();break;case"4":{const e=Mo();e?ut(e):ke(Ce);break}case"6":{const e=J.find(o=>o.id==="7");e&&re(e);break}case"7":Ae("cave"),K();break;case"9":B("achievements");break;case"10":B("values");break;case"11":B("legal");break;case"12":B("bridge");break;case"13":B("france"),K();break;case"14":case"15":l.canAccessHungary()&&B("hungary");break;case"16":case"17":l.canAccessBelgium()&&B("belgium");break;case"18":case"19":l.canAccessNetherlands()&&B("netherlands");break;case"20":case"21":l.canEnterAirport()&&Ae("airport");break;case"22":ft();break;case"23":await it(),console.log("TRAVEL FINISHED"),K();break;case"24":D("floor4"),K();break;case"25":D("floor3");break;case"26":D("floor2");break;case"27":D("floor1");break;case"28":D("floor0");break;case"29":D("exit");break;case"31":await k(1e3),K();break;case"32":WA.nav.goToRoom(`${se}#from-tower`);break;case"33":case"34":l.canLeaveBackstage()&&(we("backstage"),Co());break}}function Ho(){console.log("Town script started successfully")}console.log("Main script started successfully");WA.onInit().then(()=>{console.log("Scripting API ready"),G.initState(),y.initState(),ee.initState(),eo().then(async()=>{console.log("Scripting API Extra ready"),await l.initAsyncState(),jo(),y.hasMandatoryTags()?(je(),y.isNewbie()&&(ro(),await lt(),G.isTown()?Ho():G.isWorld()&&Wo())):(console.log("No player tag recognized."),G.isWorld()&&(console.log("Player can't access this room."),WA.nav.goToRoom(se)),je()),WA.player.name==="Valdo"&&(WA.ui.actionBar.addButton({id:"start",label:"Start",callback:async()=>{await l.setAsyncState([])}}),WA.ui.actionBar.addButton({id:"world",label:"World",callback:async()=>{await l.setAsyncState(Array.from({length:4},(t,e)=>(e+1).toString()))}}),WA.ui.actionBar.addButton({id:"bridge",label:"Bridge",callback:async()=>{await l.setAsyncState(Array.from({length:13},(t,e)=>(e+1).toString()))}}),WA.ui.actionBar.addButton({id:"airport",label:"Airport",callback:async()=>{await l.setAsyncState(Array.from({length:22},(t,e)=>(e+1).toString()))}}),WA.ui.actionBar.addButton({id:"town",label:"Town",callback:async()=>{await l.setAsyncState(Array.from({length:32},(t,e)=>(e+1).toString()))}}),WA.ui.actionBar.addButton({id:"onboarding",label:"Onboarding",callback:async()=>{await l.setAsyncState(Array.from({length:34},(t,e)=>(e+1).toString()))}}),WA.ui.actionBar.addButton({id:"finish",label:"Finish",callback:async()=>{await l.setAsyncState(Array.from({length:45},(t,e)=>(e+1).toString()))}}))}).catch(t=>console.error(t))}).catch(t=>console.error(t));
